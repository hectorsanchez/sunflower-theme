<script type="text/javascript">
// Discourse Admin Users Location Column
// Este script agrega una columna "Location" a la vista de administración de usuarios

// Función para esperar a que Discourse esté completamente cargado
function waitForDiscourse() {
  return new Promise((resolve) => {
    if (window.Discourse && window.Discourse.__container__) {
      resolve();
    } else {
      const checkInterval = setInterval(() => {
        if (window.Discourse && window.Discourse.__container__) {
          clearInterval(checkInterval);
          resolve();
        }
      }, 100);
    }
  });
}

// Función para esperar a que un elemento esté disponible en el DOM
function waitForElement(selector, timeout = 10000) {
  return new Promise((resolve, reject) => {
    const element = document.querySelector(selector);
    if (element) {
      resolve(element);
      return;
    }

    const observer = new MutationObserver((mutations, obs) => {
      const element = document.querySelector(selector);
      if (element) {
        obs.disconnect();
        resolve(element);
      }
    });

    observer.observe(document.body, {
      childList: true,
      subtree: true
    });

    // Timeout después de 10 segundos
    setTimeout(() => {
      observer.disconnect();
      reject(new Error(`Elemento ${selector} no encontrado después de ${timeout}ms`));
    }, timeout);
  });
}

// Función para encontrar la tabla de usuarios de administración
function findAdminUsersTable() {
  // Intentar diferentes selectores para encontrar la tabla
  const selectors = [
    '.directory-table.users-list',
    '.directory-table[role="table"]',
    '.users-list',
    '.admin-users-list',
    '.admin-users table',
    '.admin-users-table table',
    'table.admin-users-table',
    'table.admin-users',
    'table.users-table'
  ];

  for (const selector of selectors) {
    try {
      const element = document.querySelector(selector);
      if (element) {
        console.log(`✅ Tabla encontrada con selector: ${selector}`);
        return element;
      }
    } catch (e) {
      // Ignorar errores de selectores inválidos
    }
  }

  // Si no se encuentra con selectores específicos, buscar por contenido
  const allTables = document.querySelectorAll('[role="table"], table');
  for (const table of allTables) {
    const headers = table.querySelectorAll('[role="columnheader"], th');
    let hasUsername = false;
    let hasEmail = false;
    
    for (const header of headers) {
      const text = header.textContent.toLowerCase();
      if (text.includes('username') || text.includes('name')) {
        hasUsername = true;
      }
      if (text.includes('email')) {
        hasEmail = true;
      }
    }
    
    if (hasUsername && hasEmail) {
      console.log('✅ Tabla encontrada por contenido (username + email)');
      return table;
    }
  }

  return null;
}

// Función para analizar la estructura de la tabla encontrada
function analyzeTableStructure(table) {
  console.log('🔍 Analizando estructura de la tabla...');
  
  // Verificar si es una tabla moderna de Discourse (CSS Grid + ARIA)
  if (table.classList.contains('directory-table') || table.getAttribute('role') === 'table') {
    console.log('✅ Estructura moderna: CSS Grid + ARIA roles');
    
    // Buscar encabezados de columna
    const columnHeaders = table.querySelectorAll('.directory-table__column-header, [role="columnheader"]');
    if (columnHeaders.length > 0) {
      console.log(`📊 Encontrados ${columnHeaders.length} encabezados de columna`);
      
      // Buscar filas de datos
      const dataRows = table.querySelectorAll('.directory-table__row, [role="row"]:not([role="columnheader"])');
      console.log(`📝 Encontradas ${dataRows.length} filas de datos`);
      
      return { 
        type: 'modern', 
        table, 
        columnHeaders: Array.from(columnHeaders), 
        dataRows: Array.from(dataRows) 
      };
    }
  }
  
  // Verificar si tiene thead/tbody tradicional
  const thead = table.querySelector('thead');
  const tbody = table.querySelector('tbody');
  
  if (thead && tbody) {
    console.log('✅ Estructura tradicional: thead + tbody');
    return { type: 'traditional', thead, tbody };
  }
  
  // Si no tiene thead/tbody, buscar filas directamente
  const allRows = table.querySelectorAll('tr');
  if (allRows.length > 0) {
    console.log(`📊 Encontradas ${allRows.length} filas en la tabla`);
    
    // La primera fila suele ser el encabezado
    const headerRow = allRows[0];
    const dataRows = Array.from(allRows).slice(1);
    
    console.log('✅ Estructura alternativa: filas directas');
    return { type: 'alternative', headerRow, dataRows, allRows };
  }
  
  // Si no hay filas, buscar en elementos hijos
  const childElements = table.children;
  console.log(`🔍 Tabla tiene ${childElements.length} elementos hijos`);
  
  for (let i = 0; i < childElements.length; i++) {
    const child = childElements[i];
    console.log(`  - Elemento ${i}: ${child.tagName} (${child.className})`);
  }
  
  return null;
}

// Función para agregar event listeners de manera compatible
function addEventListenerSafe(element, event, handler) {
  if (element && typeof element.addEventListener === 'function') {
    element.addEventListener(event, handler);
  }
}

// Cache para almacenar las ubicaciones de los usuarios
const userLocationCache = new Map();

// Función para obtener la ubicación de un usuario desde la API
async function getUserLocation(username) {
  if (userLocationCache.has(username)) {
    return userLocationCache.get(username);
  }
  
  try {
    console.log(`🔍 Iniciando búsqueda de ubicación para usuario: ${username}`);
    
    // Hacer una llamada a la API de Discourse para obtener el perfil del usuario
    const apiUrl = `/u/${username}.json`;
    console.log(`📡 Llamando a API: ${apiUrl}`);
    
    const response = await fetch(apiUrl, {
      method: 'GET',
      headers: {
        'Accept': 'application/json',
        'X-Requested-With': 'XMLHttpRequest'
      }
    });
    
    console.log(`📡 Respuesta de API recibida:`, {
      status: response.status,
      statusText: response.statusText,
      ok: response.ok,
      url: response.url
    });
    
    if (response.ok) {
      const userData = await response.json();
      console.log(`📊 Datos completos del usuario ${username}:`, userData);
      
      let location = 'N/A';
      
      console.log(`🔍 Analizando datos de usuario: ${username}`);
      
      // Verificar si tenemos datos del usuario
      if (!userData.user) {
        console.log(`❌ No se encontró objeto 'user' en la respuesta`);
        console.log(`📋 Estructura de la respuesta:`, Object.keys(userData));
        userLocationCache.set(username, 'N/A');
        return 'N/A';
      }
      
      // Buscar la ubicación en el campo "location" estándar (que configuraste como público)
      if (userData.user.location) {
        location = userData.user.location;
        console.log(`✅ Ubicación encontrada en campo estándar: ${location}`);
      } else {
        console.log(`❌ Campo 'location' estándar no encontrado`);
      }
      
      // Si no se encontró en location estándar, buscar en campos personalizados públicos
      if (location === 'N/A' && userData.user.user_fields) {
        console.log(`📋 Campos personalizados disponibles:`, Object.keys(userData.user.user_fields));
        console.log(`📋 Valores de campos personalizados:`, userData.user.user_fields);
        
        // Buscar en campos personalizados (user_fields) que sean públicos
        for (let i = 1; i <= 20; i++) {
          const fieldKey = `user_field_${i}`;
          if (userData.user.user_fields[fieldKey]) {
            const fieldValue = userData.user.user_fields[fieldKey];
            console.log(`  - Campo ${fieldKey}: ${fieldValue}`);
            
            // Buscar si contiene información de ubicación
            if (fieldValue && typeof fieldValue === 'string' && 
                (fieldValue.toLowerCase().includes('location') || 
                 fieldValue.toLowerCase().includes('ubicación') ||
                 fieldValue.toLowerCase().includes('city') ||
                 fieldValue.toLowerCase().includes('country') ||
                 fieldValue.toLowerCase().includes('país') ||
                 fieldValue.toLowerCase().includes('ciudad'))) {
              location = fieldValue;
              console.log(`✅ Ubicación encontrada en campo personalizado: ${location}`);
              break;
            }
          }
        }
      }
      
      // Mostrar todos los campos disponibles del usuario para debugging
      console.log(`📋 Todos los campos disponibles del usuario:`, Object.keys(userData.user));
      console.log(`📋 Valores de campos relevantes:`, {
        location: userData.user.location,
        user_fields: userData.user.user_fields
      });
      
      // Si se encontró ubicación, extraer el país (igual que tu script Python)
      if (location !== 'N/A') {
        const country = extractCountryFromLocation(location);
        console.log(`🌍 País extraído: ${country} (de: ${location})`);
        location = country;
      } else {
        console.log(`❌ No se encontró ubicación para el usuario ${username}`);
      }
      
      // Guardar en cache
      userLocationCache.set(username, location);
      console.log(`💾 Ubicación guardada en cache para ${username}: ${location}`);
      return location;
    } else {
      console.log(`❌ Error en la respuesta de la API: ${response.status} ${response.statusText}`);
      if (response.status === 403) {
        console.log(`🔒 Error 403: Problema de permisos. Verifica que el campo 'location' esté configurado como público.`);
      } else if (response.status === 404) {
        console.log(`🔍 Error 404: Usuario no encontrado.`);
      }
    }
  } catch (error) {
    console.log(`❌ Error obteniendo ubicación del usuario ${username}:`, error);
    console.log(`📋 Stack trace completo:`, error.stack);
  }
  
  // Si falla, guardar N/A en cache para evitar reintentos
  userLocationCache.set(username, 'N/A');
  console.log(`💾 N/A guardado en cache para ${username} debido a error`);
  return 'N/A';
}

// Función para extraer el país de la ubicación (basada en tu script de Python)
function extractCountryFromLocation(location) {
  if (!location || location === 'N/A') {
    return 'Sin ubicación';
  }

  // Si la ubicación contiene una coma, tomar la última parte (país)
  if (location.includes(',')) {
    const parts = location.split(',');
    const country = parts[parts.length - 1].trim();
    return country;
  }

  // Si no hay coma, asumir que es solo el país
  return location.trim();
}

// Función para agregar la columna Location
async function addLocationColumn() {
  try {
    // Verificar si estamos en la página de administración de usuarios
    if (!window.location.pathname.includes('/admin/users/list/')) {
      console.log('📍 No estamos en la página de administración de usuarios');
      return;
    }
    
    console.log('🔍 Buscando tabla de usuarios...');
    
    // Esperar un poco más para que la página se cargue completamente
    await new Promise(resolve => setTimeout(resolve, 2000));
    
    // Buscar la tabla usando nuestra función personalizada
    const table = findAdminUsersTable();
    if (!table) {
      console.log('❌ No se pudo encontrar la tabla de usuarios');
      // Intentar de nuevo en unos segundos
      setTimeout(addLocationColumn, 3000);
      return;
    }
    
    // Analizar la estructura de la tabla
    const structure = analyzeTableStructure(table);
    if (!structure) {
      console.log('❌ No se pudo analizar la estructura de la tabla');
      return;
    }
    
    // Verificar si ya se agregó la columna
    if (table.querySelector('.location-column-header')) {
      console.log('✅ La columna Location ya está presente');
      return;
    }
    
    console.log('📊 Agregando columna Location...');
    
    if (structure.type === 'modern') {
      // Estructura moderna de Discourse (CSS Grid + ARIA)
      await addColumnToModernTable(structure.table, structure.columnHeaders, structure.dataRows);
    } else if (structure.type === 'traditional') {
      // Estructura tradicional con thead/tbody
      await addColumnToTraditionalTable(structure.thead, structure.tbody);
    } else if (structure.type === 'alternative') {
      // Estructura alternativa con filas directas
      await addColumnToAlternativeTable(structure.headerRow, structure.dataRows);
    }
    
    // Aplicar estilos CSS personalizados
    applyLocationColumnStyles();
    
    console.log('✅ Columna Location agregada exitosamente');
    
  } catch (error) {
    console.log('❌ Error agregando columna Location:', error);
    // Intentar de nuevo en unos segundos
    setTimeout(addLocationColumn, 3000);
  }
}

// Función para agregar columna a tabla moderna de Discourse
async function addColumnToModernTable(table, columnHeaders, dataRows) {
  console.log('🔧 Agregando columna a tabla moderna de Discourse...');
  
  // Crear encabezado de columna
  const locationHeader = document.createElement('div');
  locationHeader.className = 'directory-table__column-header location-column-header sortable';
  locationHeader.setAttribute('aria-sort', 'none');
  locationHeader.setAttribute('role', 'columnheader');
  
  const headerContents = document.createElement('div');
  headerContents.className = 'header-contents';
  headerContents.setAttribute('role', 'button');
  headerContents.setAttribute('tabindex', '0');
  headerContents.setAttribute('aria-label', 'Location');
  headerContents.setAttribute('aria-pressed', 'false');
  
  const textSpan = document.createElement('span');
  textSpan.className = 'text';
  textSpan.textContent = 'Location';
  
  headerContents.appendChild(textSpan);
  locationHeader.appendChild(headerContents);
  
  // Insertar el encabezado antes del último encabezado existente
  if (columnHeaders.length > 0) {
    const lastHeader = columnHeaders[columnHeaders.length - 1];
    lastHeader.parentNode.insertBefore(locationHeader, lastHeader.nextSibling);
  } else {
    // Si no hay encabezados, insertar en el contenedor de encabezados
    const headerContainer = table.querySelector('.directory-table__header');
    if (headerContainer) {
      headerContainer.appendChild(locationHeader);
    }
  }
  
  // Agregar celdas de datos
  console.log(`📝 Agregando celdas para ${dataRows.length} filas...`);
  
  for (const row of dataRows) {
    await addLocationCellToModernRow(row);
  }
  
  // Actualizar el CSS Grid para incluir la nueva columna
  updateGridColumns(table);
}

// Función para agregar celda de ubicación a una fila moderna
async function addLocationCellToModernRow(row) {
  const locationCell = document.createElement('div');
  locationCell.className = 'directory-table__cell location-column-data';
  locationCell.setAttribute('role', 'cell');
  
  // Obtener el username de la fila
  const usernameCell = row.querySelector('.directory-table__cell--username, [data-username]');
  let username = '';
  
  if (usernameCell) {
    // Buscar el enlace del username
    const usernameLink = usernameCell.querySelector('a');
    if (usernameLink) {
      username = usernameLink.textContent.trim();
    } else {
      username = usernameCell.textContent.trim();
    }
  }
  
  if (username) {
    // Mostrar "Cargando..." inicialmente
    locationCell.textContent = 'Cargando...';
    locationCell.style.fontStyle = 'italic';
    locationCell.style.color = '#666';
    
    // Obtener la ubicación del usuario
    getUserLocation(username).then(location => {
      locationCell.textContent = location;
      locationCell.style.fontStyle = 'normal';
      locationCell.style.color = '#40312a';
      
      // Aplicar estilos especiales para ubicaciones válidas
      if (location !== 'N/A') {
        locationCell.style.fontWeight = '500';
        locationCell.style.color = '#8A4A19';
      }
    });
  } else {
    locationCell.textContent = 'N/A';
  }
  
  // Insertar la celda en la posición correcta
  const lastCell = row.querySelector('.directory-table__cell:last-child');
  if (lastCell) {
    row.insertBefore(locationCell, lastCell.nextSibling);
  } else {
    row.appendChild(locationCell);
  }
}

// Función para actualizar las columnas del CSS Grid
function updateGridColumns(table) {
  const currentStyle = table.style.gridTemplateColumns;
  if (currentStyle) {
    // Agregar una columna más al grid
    const newStyle = currentStyle.replace(/\)$/, ' minmax(min-content, 1fr))');
    table.style.gridTemplateColumns = newStyle;
    console.log('🔧 CSS Grid actualizado para incluir la nueva columna');
  }
}

// Función para agregar columna a tabla tradicional
async function addColumnToTraditionalTable(thead, tbody) {
  const headerRow = thead.querySelector('tr');
  if (!headerRow) return;
  
  // Agregar encabezado de columna
  const locationHeader = document.createElement('th');
  locationHeader.className = 'location-column-header';
  locationHeader.textContent = 'Location';
  locationHeader.style.minWidth = '120px';
  locationHeader.style.textAlign = 'center';
  
  // Insertar antes de la última columna
  const lastHeader = headerRow.querySelector('th:last-child');
  if (lastHeader) {
    headerRow.insertBefore(locationHeader, lastHeader);
  } else {
    headerRow.appendChild(locationHeader);
  }
  
  // Agregar celdas de datos
  const rows = tbody.querySelectorAll('tr');
  console.log(`📝 Agregando celdas para ${rows.length} filas...`);
  
  for (const row of rows) {
    await addLocationCellToRow(row);
  }
}

// Función para agregar columna a tabla alternativa
async function addColumnToAlternativeTable(headerRow, dataRows) {
  // Agregar encabezado de columna
  const locationHeader = document.createElement('th');
  locationHeader.className = 'location-column-header';
  locationHeader.textContent = 'Location';
  locationHeader.style.minWidth = '120px';
  locationHeader.style.textAlign = 'center';
  
  // Insertar antes de la última columna
  const lastHeader = headerRow.querySelector('th:last-child');
  if (lastHeader) {
    headerRow.insertBefore(locationHeader, lastHeader);
  } else {
    headerRow.appendChild(locationHeader);
  }
  
  // Agregar celdas de datos
  console.log(`📝 Agregando celdas para ${dataRows.length} filas...`);
  
  for (const row of dataRows) {
    await addLocationCellToRow(row);
  }
}

// Función para agregar celda de ubicación a una fila tradicional
async function addLocationCellToRow(row) {
  const locationCell = document.createElement('td');
  locationCell.className = 'location-column-data';
  locationCell.style.textAlign = 'center';
  locationCell.style.verticalAlign = 'middle';
  
  // Obtener el username de la fila
  const usernameLink = row.querySelector('td:first-child a');
  if (usernameLink) {
    const username = usernameLink.textContent.trim();
    
    // Mostrar "Cargando..." inicialmente
    locationCell.textContent = 'Cargando...';
    locationCell.style.fontStyle = 'italic';
    locationCell.style.color = '#666';
    
    // Obtener la ubicación del usuario
    getUserLocation(username).then(location => {
      locationCell.textContent = location;
      locationCell.style.fontStyle = 'normal';
      locationCell.style.color = '#40312a';
      
      // Aplicar estilos especiales para ubicaciones válidas
      if (location !== 'N/A') {
        locationCell.style.fontWeight = '500';
        locationCell.style.color = '#8A4A19';
      }
    });
  } else {
    locationCell.textContent = 'N/A';
  }
  
  // Insertar la celda en la posición correcta
  const lastCell = row.querySelector('td:last-child');
  if (lastCell) {
    row.insertBefore(locationCell, lastCell);
  } else {
    row.appendChild(locationCell);
  }
}

// Función para aplicar estilos CSS
function applyLocationColumnStyles() {
  const style = document.createElement('style');
  style.setAttribute('data-location-column', 'true');
  style.textContent = `
    .location-column-header {
      background-color: #f4d35e !important;
      color: #40312a !important;
      font-weight: 600 !important;
      border: 1px solid #e0c052 !important;
      padding: 8px 12px !important;
      text-align: center !important;
      vertical-align: middle !important;
    }
    
    .location-column-data {
      background-color: #faf0ca !important;
      border: 1px solid #eadac9 !important;
      color: #40312a !important;
      font-size: 0.9em !important;
      padding: 8px 12px !important;
      text-align: center !important;
      vertical-align: middle !important;
      transition: all 0.2s ease !important;
    }
    
    .location-column-data:hover {
      background-color: #f0c052 !important;
      color: #212121 !important;
      transform: scale(1.02) !important;
    }
    
    /* Estilos para tablas modernas de Discourse */
    .directory-table .location-column-header {
      background-color: #f4d35e !important;
      color: #40312a !important;
      font-weight: 600 !important;
      border: 1px solid #e0c052 !important;
      padding: 8px 12px !important;
      text-align: center !important;
      vertical-align: middle !important;
    }
    
    .directory-table .location-column-data {
      background-color: #faf0ca !important;
      border: 1px solid #eadac9 !important;
      color: #40312a !important;
      font-size: 0.9em !important;
      padding: 8px 12px !important;
      text-align: center !important;
      vertical-align: middle !important;
      transition: all 0.2s ease !important;
    }
    
    .directory-table .location-column-data:hover {
      background-color: #f0c052 !important;
      color: #212121 !important;
      transform: scale(1.02) !important;
    }
    
    /* Estilos para la tabla completa */
    .admin-users-table table,
    .admin-users table,
    .users-table table,
    .admin-users-list table,
    .admin-users-list,
    .directory-table {
      border-collapse: collapse !important;
    }
    
    .admin-users-table th,
    .admin-users-table td,
    .admin-users th,
    .admin-users td,
    .users-table th,
    .users-table td,
    .admin-users-list th,
    .admin-users-list td,
    .directory-table__column-header,
    .directory-table__cell {
      border: 1px solid #eadac9 !important;
    }
  `;
  document.head.appendChild(style);
}

// Función para limpiar la columna cuando se cambia de página
function cleanupLocationColumn() {
  const existingHeader = document.querySelector('.location-column-header');
  const existingCells = document.querySelectorAll('.location-column-data');
  const existingStyle = document.querySelector('style[data-location-column]');
  
  if (existingHeader) existingHeader.remove();
  existingCells.forEach(cell => cell.remove());
  if (existingStyle) existingStyle.remove();
}

// Función principal que se ejecuta cuando Discourse esté listo
async function initLocationColumn() {
  try {
    // Esperar a que Discourse esté completamente cargado
    await waitForDiscourse();
    
    console.log('🚀 Inicializando columna Location...');
    
    // Ejecutar cuando se carga la página
    await addLocationColumn();
    
    // Ejecutar cuando cambia la URL (navegación SPA de Discourse)
    let currentUrl = window.location.href;
    const observer = new MutationObserver(function() {
      if (window.location.href !== currentUrl) {
        currentUrl = window.location.href;
        
        // Limpiar columna anterior
        cleanupLocationColumn();
        
        // Agregar nueva columna
        setTimeout(addLocationColumn, 1000);
      }
    });
    
    observer.observe(document.body, {
      childList: true,
      subtree: true
    });
    
    // También ejecutar cuando se hace clic en enlaces de navegación
    document.addEventListener('click', function(event) {
      const target = event.target.closest('a');
      if (target && target.href && target.href.includes('/admin/users/list/')) {
        setTimeout(() => {
          cleanupLocationColumn();
          addLocationColumn();
        }, 1000);
      }
    });
    
    // Ejecutar cuando se cambia entre pestañas (Active, New, Staff, etc.)
    document.addEventListener('click', function(event) {
      const target = event.target.closest('a');
      if (target && target.classList.contains('ember-view')) {
        const href = target.getAttribute('href');
        if (href && (href.includes('/admin/users/list/') || href.includes('/admin/groups'))) {
          setTimeout(() => {
            cleanupLocationColumn();
            addLocationColumn();
          }, 1500);
        }
      }
    });
    
    console.log('🚀 Columna Location inicializada correctamente');
    
  } catch (error) {
    console.log('❌ Error inicializando columna Location:', error);
  }
}

// Iniciar cuando el DOM esté listo
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initLocationColumn);
} else {
  initLocationColumn();
}
</script>
