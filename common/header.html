<script type="text/javascript">
// Discourse Admin Users Location Column
// Este script agrega una columna "Location" a la vista de administraciÃ³n de usuarios

// FunciÃ³n para esperar a que Discourse estÃ© completamente cargado
function waitForDiscourse() {
  return new Promise((resolve) => {
    if (window.Discourse && window.Discourse.__container__) {
      resolve();
    } else {
      const checkInterval = setInterval(() => {
        if (window.Discourse && window.Discourse.__container__) {
          clearInterval(checkInterval);
          resolve();
        }
      }, 100);
    }
  });
}

// FunciÃ³n para esperar a que un elemento estÃ© disponible en el DOM
function waitForElement(selector, timeout = 10000) {
  return new Promise((resolve, reject) => {
    const element = document.querySelector(selector);
    if (element) {
      resolve(element);
      return;
    }

    const observer = new MutationObserver((mutations, obs) => {
      const element = document.querySelector(selector);
      if (element) {
        obs.disconnect();
        resolve(element);
      }
    });

    observer.observe(document.body, {
      childList: true,
      subtree: true
    });

    // Timeout despuÃ©s de 10 segundos
    setTimeout(() => {
      observer.disconnect();
      reject(new Error(`Elemento ${selector} no encontrado despuÃ©s de ${timeout}ms`));
    }, timeout);
  });
}

// FunciÃ³n para encontrar la tabla de usuarios (admin o pÃºblica)
function findUsersTable() {
  // Intentar diferentes selectores para encontrar la tabla
  const selectors = [
    '.directory-table.users-list',
    '.directory-table[role="table"]',
    '.directory-table', // Para vista pÃºblica
    '.users-list',
    '.admin-users-list',
    '.admin-users table',
    '.admin-users-table table',
    'table.admin-users-table',
    'table.admin-users',
    'table.users-table'
  ];

  for (const selector of selectors) {
    try {
      const element = document.querySelector(selector);
      if (element) {
        console.log(`âœ… Tabla encontrada con selector: ${selector}`);
        return element;
      }
    } catch (e) {
      // Ignorar errores de selectores invÃ¡lidos
    }
  }

  // Si no se encuentra con selectores especÃ­ficos, buscar por contenido
  const allTables = document.querySelectorAll('[role="table"], table');
  for (const table of allTables) {
    const headers = table.querySelectorAll('[role="columnheader"], th');
    let hasUsername = false;
    let hasEmail = false;
    
    for (const header of headers) {
      const text = header.textContent.toLowerCase();
      if (text.includes('username') || text.includes('name')) {
        hasUsername = true;
      }
      if (text.includes('email')) {
        hasEmail = true;
      }
    }
    
    if (hasUsername && hasEmail) {
      console.log('âœ… Tabla encontrada por contenido (username + email)');
      return table;
    }
  }

  return null;
}

// FunciÃ³n para analizar la estructura de la tabla encontrada
function analyzeTableStructure(table) {
  // Verificar si es una tabla moderna de Discourse (CSS Grid + ARIA)
  if (table.classList.contains('directory-table') || table.getAttribute('role') === 'table') {
    
    // Buscar encabezados de columna
    const columnHeaders = table.querySelectorAll('.directory-table__column-header, [role="columnheader"]');
    if (columnHeaders.length > 0) {
      
      // Buscar filas de datos
      const dataRows = table.querySelectorAll('.directory-table__row, [role="row"]:not([role="columnheader"])');
      
      return { 
        type: 'modern', 
        table, 
        columnHeaders: Array.from(columnHeaders), 
        dataRows: Array.from(dataRows) 
      };
    }
  }
  
  // Verificar si tiene thead/tbody tradicional
  const thead = table.querySelector('thead');
  const tbody = table.querySelector('tbody');
  
  if (thead && tbody) {
    console.log('âœ… Estructura tradicional: thead + tbody');
    return { type: 'traditional', thead, tbody };
  }
  
  // Si no tiene thead/tbody, buscar filas directamente
  const allRows = table.querySelectorAll('tr');
  if (allRows.length > 0) {
    console.log(`ğŸ“Š Encontradas ${allRows.length} filas en la tabla`);
    
    // La primera fila suele ser el encabezado
    const headerRow = allRows[0];
    const dataRows = Array.from(allRows).slice(1);
    
    console.log('âœ… Estructura alternativa: filas directas');
    return { type: 'alternative', headerRow, dataRows, allRows };
  }
  
  // Si no hay filas, buscar en elementos hijos
  const childElements = table.children;

  
  return null;
}

// FunciÃ³n para agregar event listeners de manera compatible
function addEventListenerSafe(element, event, handler) {
  if (element && typeof element.addEventListener === 'function') {
    element.addEventListener(event, handler);
  }
}

// Cache para almacenar las ubicaciones de los usuarios
const userLocationCache = new Map();

// FunciÃ³n para obtener la ubicaciÃ³n de un usuario desde la API
async function getUserLocation(username) {
  if (userLocationCache.has(username)) {
    return userLocationCache.get(username);
  }
  
  try {
    console.log(`ğŸ” Iniciando bÃºsqueda de ubicaciÃ³n para usuario: ${username}`);
    
    // Hacer una llamada a la API de Discourse para obtener el perfil del usuario
    const apiUrl = `/u/${username}.json`;
    console.log(`ğŸ“¡ Llamando a API: ${apiUrl}`);
    
    const response = await fetch(apiUrl, {
      method: 'GET',
      headers: {
        'Accept': 'application/json',
        'X-Requested-With': 'XMLHttpRequest'
      }
    });
    
    console.log(`ğŸ“¡ Respuesta de API recibida:`, {
      status: response.status,
      statusText: response.statusText,
      ok: response.ok,
      url: response.url
    });
    
    if (response.ok) {
      const userData = await response.json();
      console.log(`ğŸ“Š Datos completos del usuario ${username}:`, userData);
      
      let location = 'N/A';
      
      console.log(`ğŸ” Analizando datos de usuario: ${username}`);
      
      // Verificar si tenemos datos del usuario
      if (!userData.user) {
        console.log(`âŒ No se encontrÃ³ objeto 'user' en la respuesta`);
        console.log(`ğŸ“‹ Estructura de la respuesta:`, Object.keys(userData));
        userLocationCache.set(username, 'N/A');
        return 'N/A';
      }
      
      // Buscar la ubicaciÃ³n en el campo "location" estÃ¡ndar (que configuraste como pÃºblico)
      if (userData.user.location) {
        location = userData.user.location;
        console.log(`âœ… UbicaciÃ³n encontrada en campo estÃ¡ndar: ${location}`);
      } else {
        console.log(`âŒ Campo 'location' estÃ¡ndar no encontrado`);
      }
      
      // Si no se encontrÃ³ en location estÃ¡ndar, buscar en campos personalizados pÃºblicos
      if (location === 'N/A' && userData.user.user_fields) {
        console.log(`ğŸ“‹ Campos personalizados disponibles:`, Object.keys(userData.user.user_fields));
        console.log(`ğŸ“‹ Valores de campos personalizados:`, userData.user.user_fields);
        
        // Buscar en campos personalizados (user_fields) que sean pÃºblicos
        for (let i = 1; i <= 20; i++) {
          const fieldKey = `user_field_${i}`;
          if (userData.user.user_fields[fieldKey]) {
            const fieldValue = userData.user.user_fields[fieldKey];
            console.log(`  - Campo ${fieldKey}: ${fieldValue}`);
            
            // Buscar si contiene informaciÃ³n de ubicaciÃ³n
            if (fieldValue && typeof fieldValue === 'string' && 
                (fieldValue.toLowerCase().includes('location') || 
                 fieldValue.toLowerCase().includes('ubicaciÃ³n') ||
                 fieldValue.toLowerCase().includes('city') ||
                 fieldValue.toLowerCase().includes('country') ||
                 fieldValue.toLowerCase().includes('paÃ­s') ||
                 fieldValue.toLowerCase().includes('ciudad'))) {
              location = fieldValue;
              console.log(`âœ… UbicaciÃ³n encontrada en campo personalizado: ${location}`);
              break;
            }
          }
        }
      }
      
      // Mostrar todos los campos disponibles del usuario para debugging
      console.log(`ğŸ“‹ Todos los campos disponibles del usuario:`, Object.keys(userData.user));
      console.log(`ğŸ“‹ Valores de campos relevantes:`, {
        location: userData.user.location,
        user_fields: userData.user.user_fields
      });
      
      // Si se encontrÃ³ ubicaciÃ³n, extraer el paÃ­s (igual que tu script Python)
      if (location !== 'N/A') {
        const country = extractCountryFromLocation(location);
        console.log(`ğŸŒ PaÃ­s extraÃ­do: ${country} (de: ${location})`);
        location = country;
      } else {
        console.log(`âŒ No se encontrÃ³ ubicaciÃ³n para el usuario ${username}`);
      }
      
      // Guardar en cache
      userLocationCache.set(username, location);
      console.log(`ğŸ’¾ UbicaciÃ³n guardada en cache para ${username}: ${location}`);
      return location;
    } else {
      console.log(`âŒ Error en la respuesta de la API: ${response.status} ${response.statusText}`);
      if (response.status === 403) {
        console.log(`ğŸ”’ Error 403: Problema de permisos. Verifica que el campo 'location' estÃ© configurado como pÃºblico.`);
      } else if (response.status === 404) {
        console.log(`ğŸ” Error 404: Usuario no encontrado.`);
      }
    }
  } catch (error) {
    console.log(`âŒ Error obteniendo ubicaciÃ³n del usuario ${username}:`, error);
    console.log(`ğŸ“‹ Stack trace completo:`, error.stack);
  }
  
  // Si falla, guardar N/A en cache para evitar reintentos
  userLocationCache.set(username, 'N/A');
  console.log(`ğŸ’¾ N/A guardado en cache para ${username} debido a error`);
  return 'N/A';
}

// FunciÃ³n para extraer el paÃ­s de la ubicaciÃ³n (basada en tu script de Python)
function extractCountryFromLocation(location) {
  if (!location || location === 'N/A') {
    return 'Sin ubicaciÃ³n';
  }

  // Si la ubicaciÃ³n contiene una coma, tomar la Ãºltima parte (paÃ­s)
  if (location.includes(',')) {
    const parts = location.split(',');
    const country = parts[parts.length - 1].trim();
    return country;
  }

  // Si no hay coma, asumir que es solo el paÃ­s
  return location.trim();
}

// FunciÃ³n para agregar la columna Location
async function addLocationColumn() {
  try {
    // Verificar si estamos en una pÃ¡gina de usuarios (admin o pÃºblica)
    const isAdminUsersPage = window.location.pathname.includes('/admin/users/list/');
    const isPublicUsersPage = window.location.pathname.includes('/u') && 
      (window.location.search.includes('order=') || window.location.pathname === '/u');
    
    if (!isAdminUsersPage && !isPublicUsersPage) {
      console.log('ğŸ“ No estamos en una pÃ¡gina de usuarios (admin o pÃºblica)');
      return;
    }
    
    console.log(`ğŸ“ Detectada vista de usuarios: ${isAdminUsersPage ? 'AdministraciÃ³n' : 'PÃºblica'}`);
    
    console.log('ğŸ” Buscando tabla de usuarios...');
    
    // Esperar un poco mÃ¡s para que la pÃ¡gina se cargue completamente
    await new Promise(resolve => setTimeout(resolve, 2000));
    
    // Buscar la tabla usando nuestra funciÃ³n personalizada
    const table = findUsersTable();
    if (!table) {
      console.log('âŒ No se pudo encontrar la tabla de usuarios');
      // Intentar de nuevo en unos segundos
      setTimeout(addLocationColumn, 3000);
      return;
    }
    
    // Analizar la estructura de la tabla
    const structure = analyzeTableStructure(table);
    if (!structure) {
      console.log('âŒ No se pudo analizar la estructura de la tabla');
      return;
    }
    
    // Verificar si ya se agregÃ³ la columna
    if (table.querySelector('.location-column-header')) {
      console.log('âœ… La columna Location ya estÃ¡ presente');
      return;
    }
    
    console.log('ğŸ“Š Agregando columna Location...');
    
    if (structure.type === 'modern') {
      // Estructura moderna de Discourse (CSS Grid + ARIA)
      await addColumnToModernTable(structure.table, structure.columnHeaders, structure.dataRows);
    } else if (structure.type === 'traditional') {
      // Estructura tradicional con thead/tbody
      await addColumnToTraditionalTable(structure.thead, structure.tbody);
    } else if (structure.type === 'alternative') {
      // Estructura alternativa con filas directas
      await addColumnToAlternativeTable(structure.headerRow, structure.dataRows);
    }
    
    // Aplicar estilos CSS personalizados
    applyLocationColumnStyles();
    
    console.log('âœ… Columna Location agregada exitosamente');
    
  } catch (error) {
    console.log('âŒ Error agregando columna Location:', error);
    // Intentar de nuevo en unos segundos
    setTimeout(addLocationColumn, 3000);
  }
}

// FunciÃ³n para agregar columna a tabla moderna de Discourse
async function addColumnToModernTable(table, columnHeaders, dataRows) {
  console.log('ğŸ”§ Agregando columna a tabla moderna de Discourse...');
  
  // Crear encabezado de columna
  const locationHeader = document.createElement('div');
  locationHeader.className = 'directory-table__column-header location-column-header sortable';
  locationHeader.setAttribute('aria-sort', 'none');
  locationHeader.setAttribute('role', 'columnheader');
  
  const headerContents = document.createElement('div');
  headerContents.className = 'header-contents';
  headerContents.setAttribute('role', 'button');
  headerContents.setAttribute('tabindex', '0');
  headerContents.setAttribute('aria-label', 'Location');
  headerContents.setAttribute('aria-pressed', 'false');
  
  const textSpan = document.createElement('span');
  textSpan.className = 'text';
  textSpan.textContent = 'Location';
  
  headerContents.appendChild(textSpan);
  locationHeader.appendChild(headerContents);
  
  // Insertar el encabezado antes del Ãºltimo encabezado existente
  if (columnHeaders.length > 0) {
    const lastHeader = columnHeaders[columnHeaders.length - 1];
    lastHeader.parentNode.insertBefore(locationHeader, lastHeader.nextSibling);
  } else {
    // Si no hay encabezados, insertar en el contenedor de encabezados
    const headerContainer = table.querySelector('.directory-table__header');
    if (headerContainer) {
      headerContainer.appendChild(locationHeader);
    }
  }
  
  // Agregar celdas de datos
  console.log(`ğŸ“ Agregando celdas para ${dataRows.length} filas...`);
  
  for (const row of dataRows) {
    await addLocationCellToModernRow(row);
  }
  
  // Actualizar el CSS Grid para incluir la nueva columna
  updateGridColumns(table);
  
  // Agregar filtro por ubicaciÃ³n
  await addLocationFilter(table, dataRows);
}

// FunciÃ³n para agregar celda de ubicaciÃ³n a una fila moderna
async function addLocationCellToModernRow(row) {
  console.log('ğŸ” Procesando fila:', row);
  
  const locationCell = document.createElement('div');
  locationCell.className = 'directory-table__cell location-column-data';
  locationCell.setAttribute('role', 'cell');
  
  // Obtener el username de la fila
  const usernameCell = row.querySelector('.directory-table__cell.username');
  let username = '';
  
  console.log('ğŸ” Celda de username encontrada:', usernameCell);
  
  if (usernameCell) {
    console.log('ğŸ” Contenido de la celda username:', usernameCell.innerHTML);
    
    // Buscar el enlace del username (el segundo enlace con clase ember-view)
    const usernameLink = usernameCell.querySelector('a.ember-view');
    console.log('ğŸ” Enlace username encontrado:', usernameLink);
    
    if (usernameLink) {
      username = usernameLink.textContent.trim();
      console.log('ğŸ” Username extraÃ­do del enlace:', username);
    } else {
      // Intentar otros selectores para la vista pÃºblica
      const avatarLink = usernameCell.querySelector('a.avatar');
      if (avatarLink) {
        const href = avatarLink.getAttribute('href');
        if (href && href.startsWith('/u/')) {
          username = href.split('/u/')[1];
          console.log('ğŸ” Username extraÃ­do del avatar link:', username);
        }
      }
      
      if (!username) {
        username = usernameCell.textContent.trim();
        console.log('ğŸ” Username extraÃ­do del texto:', username);
      }
    }
  } else {
    console.log('âŒ No se encontrÃ³ celda de username en la fila');
    // Intentar otros selectores para la vista pÃºblica
    const allCells = row.querySelectorAll('.directory-table__cell');
    console.log('ğŸ” Todas las celdas de la fila:', allCells);
    
    for (const cell of allCells) {
      const links = cell.querySelectorAll('a');
      for (const link of links) {
        const href = link.getAttribute('href');
        if (href && href.startsWith('/u/')) {
          username = href.split('/u/')[1];
          console.log('ğŸ” Username encontrado en enlace alternativo:', username);
          break;
        }
      }
      if (username) break;
    }
  }
  
  if (username) {
    // Mostrar "Cargando..." inicialmente
    locationCell.textContent = 'Cargando...';
    locationCell.style.fontStyle = 'italic';
    locationCell.style.color = '#666';
    
    // Obtener la ubicaciÃ³n del usuario
    getUserLocation(username).then(location => {
      locationCell.textContent = location;
      locationCell.style.fontStyle = 'normal';
      locationCell.style.color = '#40312a';
      
      // Aplicar estilos especiales para ubicaciones vÃ¡lidas
      if (location !== 'N/A') {
        locationCell.style.fontWeight = '500';
        locationCell.style.color = '#8A4A19';
      }
    });
  } else {
    locationCell.textContent = 'N/A';
  }
  
  // Insertar la celda en la posiciÃ³n correcta
  const lastCell = row.querySelector('.directory-table__cell:last-child');
  if (lastCell) {
    row.insertBefore(locationCell, lastCell.nextSibling);
  } else {
    row.appendChild(locationCell);
  }
}

// FunciÃ³n para actualizar las columnas del CSS Grid
function updateGridColumns(table) {
  const currentStyle = table.style.gridTemplateColumns;
  if (currentStyle) {
    // Agregar una columna mÃ¡s al grid
    const newStyle = currentStyle.replace(/\)$/, ' minmax(min-content, 1fr))');
    table.style.gridTemplateColumns = newStyle;
    console.log('ğŸ”§ CSS Grid actualizado para incluir la nueva columna');
  }
}

// FunciÃ³n para agregar filtro por ubicaciÃ³n
async function addLocationFilter(table, dataRows) {
  console.log('ğŸ” Agregando filtro por ubicaciÃ³n...');
  
  // Esperar a que todas las ubicaciones se carguen
  await new Promise(resolve => setTimeout(resolve, 3000));
  
  // Recopilar todas las ubicaciones Ãºnicas
  const locations = new Set();
  const locationCells = table.querySelectorAll('.location-column-data');
  
  locationCells.forEach(cell => {
    const location = cell.textContent.trim();
    if (location && location !== 'Cargando...') {
      locations.add(location);
    }
  });
  
  console.log(`ğŸ“ Ubicaciones encontradas:`, Array.from(locations));
  
  // Crear el contenedor del filtro
  const filterContainer = document.createElement('div');
  filterContainer.className = 'location-filter-container';
  filterContainer.style.cssText = `
    margin: 10px 0;
    padding: 10px;
    background-color: #faf0ca;
    border: 1px solid #eadac9;
    border-radius: 4px;
    display: flex;
    align-items: center;
    gap: 10px;
  `;
  
  // Crear etiqueta
  const label = document.createElement('label');
  label.textContent = 'Filter by Location:';
  label.style.cssText = `
    font-weight: 600;
    color: #40312a;
    margin-right: 5px;
  `;
  
  // Crear dropdown
  const select = document.createElement('select');
  select.className = 'location-filter-select';
  select.style.cssText = `
    padding: 5px 10px;
    border: 1px solid #e0c052;
    border-radius: 4px;
    background-color: #ffffff;
    color: #40312a;
    font-size: 14px;
    min-width: 150px;
  `;
  
  // Agregar opciones
  const allOption = document.createElement('option');
  allOption.value = 'all';
  allOption.textContent = 'All users';
  select.appendChild(allOption);
  
  const noLocationOption = document.createElement('option');
  noLocationOption.value = 'no-location';
  noLocationOption.textContent = 'No location';
  select.appendChild(noLocationOption);
  
  // Agregar opciones de ubicaciones
  const sortedLocations = Array.from(locations).sort();
  sortedLocations.forEach(location => {
    const option = document.createElement('option');
    option.value = location;
    option.textContent = location;
    select.appendChild(option);
  });
  
  // Crear contador
  const counter = document.createElement('span');
  counter.className = 'location-filter-counter';
  counter.style.cssText = `
    color: #8A4A19;
    font-weight: 500;
    font-size: 14px;
  `;
  
  // FunciÃ³n para actualizar el contador
  function updateCounter() {
    const visibleRows = table.querySelectorAll('.directory-table__row:not([style*="display: none"])');
    const totalRows = dataRows.length;
    counter.textContent = `${visibleRows.length} of ${totalRows} users`;
  }
  
  // FunciÃ³n para filtrar
  function filterByLocation(selectedLocation) {
    console.log(`ğŸ” Filtrando por ubicaciÃ³n: ${selectedLocation}`);
    
    dataRows.forEach(row => {
      const locationCell = row.querySelector('.location-column-data');
      if (locationCell) {
        const cellLocation = locationCell.textContent.trim();
        
        if (selectedLocation === 'all') {
          row.style.display = '';
        } else if (selectedLocation === 'no-location') {
          row.style.display = (cellLocation === 'N/A' || cellLocation === 'Cargando...') ? '' : 'none';
        } else {
          row.style.display = (cellLocation === selectedLocation) ? '' : 'none';
        }
      }
    });
    
    updateCounter();
  }
  
  // Event listener para el filtro
  select.addEventListener('change', (e) => {
    filterByLocation(e.target.value);
  });
  
  // Ensamblar el filtro
  filterContainer.appendChild(label);
  filterContainer.appendChild(select);
  filterContainer.appendChild(counter);
  
  // Insertar el filtro antes de la tabla
  const tableContainer = table.closest('.directory-table-container') || table.parentNode;
  if (tableContainer) {
    tableContainer.insertBefore(filterContainer, table);
  }
  
  // Actualizar contador inicial
  updateCounter();
  
  console.log('âœ… Filtro por ubicaciÃ³n agregado exitosamente');
}

// FunciÃ³n para agregar columna a tabla tradicional
async function addColumnToTraditionalTable(thead, tbody) {
  const headerRow = thead.querySelector('tr');
  if (!headerRow) return;
  
  // Agregar encabezado de columna
  const locationHeader = document.createElement('th');
  locationHeader.className = 'location-column-header';
  locationHeader.textContent = 'Location';
  locationHeader.style.minWidth = '120px';
  locationHeader.style.textAlign = 'center';
  
  // Insertar antes de la Ãºltima columna
  const lastHeader = headerRow.querySelector('th:last-child');
  if (lastHeader) {
    headerRow.insertBefore(locationHeader, lastHeader);
  } else {
    headerRow.appendChild(locationHeader);
  }
  
  // Agregar celdas de datos
  const rows = tbody.querySelectorAll('tr');
  console.log(`ğŸ“ Agregando celdas para ${rows.length} filas...`);
  
  for (const row of rows) {
    await addLocationCellToRow(row);
  }
}

// FunciÃ³n para agregar columna a tabla alternativa
async function addColumnToAlternativeTable(headerRow, dataRows) {
  // Agregar encabezado de columna
  const locationHeader = document.createElement('th');
  locationHeader.className = 'location-column-header';
  locationHeader.textContent = 'Location';
  locationHeader.style.minWidth = '120px';
  locationHeader.style.textAlign = 'center';
  
  // Insertar antes de la Ãºltima columna
  const lastHeader = headerRow.querySelector('th:last-child');
  if (lastHeader) {
    headerRow.insertBefore(locationHeader, lastHeader);
  } else {
    headerRow.appendChild(locationHeader);
  }
  
  // Agregar celdas de datos
  console.log(`ğŸ“ Agregando celdas para ${dataRows.length} filas...`);
  
  for (const row of dataRows) {
    await addLocationCellToRow(row);
  }
}

// FunciÃ³n para agregar celda de ubicaciÃ³n a una fila tradicional
async function addLocationCellToRow(row) {
  const locationCell = document.createElement('td');
  locationCell.className = 'location-column-data';
  locationCell.style.textAlign = 'center';
  locationCell.style.verticalAlign = 'middle';
  
  // Obtener el username de la fila
  const usernameLink = row.querySelector('td:first-child a');
  if (usernameLink) {
    const username = usernameLink.textContent.trim();
    
    // Mostrar "Cargando..." inicialmente
    locationCell.textContent = 'Cargando...';
    locationCell.style.fontStyle = 'italic';
    locationCell.style.color = '#666';
    
    // Obtener la ubicaciÃ³n del usuario
    getUserLocation(username).then(location => {
      locationCell.textContent = location;
      locationCell.style.fontStyle = 'normal';
      locationCell.style.color = '#40312a';
      
      // Aplicar estilos especiales para ubicaciones vÃ¡lidas
      if (location !== 'N/A') {
        locationCell.style.fontWeight = '500';
        locationCell.style.color = '#8A4A19';
      }
    });
  } else {
    locationCell.textContent = 'N/A';
  }
  
  // Insertar la celda en la posiciÃ³n correcta
  const lastCell = row.querySelector('td:last-child');
  if (lastCell) {
    row.insertBefore(locationCell, lastCell);
  } else {
    row.appendChild(locationCell);
  }
}

// FunciÃ³n para aplicar estilos CSS
function applyLocationColumnStyles() {
  const style = document.createElement('style');
  style.setAttribute('data-location-column', 'true');
  style.textContent = `
    .location-column-header {
      color: #40312a !important;
      font-weight: 600 !important;
      padding: 8px 12px !important;
      text-align: center !important;
      vertical-align: middle !important;
    }
    
    .location-column-data {
      color: #40312a !important;
      font-size: 0.9em !important;
      padding: 8px 12px !important;
      text-align: center !important;
      vertical-align: middle !important;
      transition: all 0.2s ease !important;
    }
    
    .location-column-data:hover {
      color: #212121 !important;
    }
    
    /* Estilos para tablas modernas de Discourse */
    .directory-table .location-column-header {
      color: #40312a !important;
      font-weight: 600 !important;
      padding: 8px 12px !important;
      text-align: center !important;
      vertical-align: middle !important;
    }
    
    .directory-table .location-column-data {
      color: #40312a !important;
      font-size: 0.9em !important;
      padding: 8px 12px !important;
      text-align: center !important;
      vertical-align: middle !important;
      transition: all 0.2s ease !important;
    }
    
    .directory-table .location-column-data:hover {
      color: #212121 !important;
    }
    
    /* Estilos para el filtro por ubicaciÃ³n */
    .location-filter-container {
      margin: 10px 0 !important;
      padding: 10px !important;
      background-color: #faf0ca !important;
      border: 1px solid #eadac9 !important;
      border-radius: 4px !important;
      display: flex !important;
      align-items: center !important;
      gap: 10px !important;
    }
    
    .location-filter-container label {
      font-weight: 600 !important;
      color: #40312a !important;
      margin-right: 5px !important;
    }
    
    .location-filter-select {
      padding: 5px 10px !important;
      border: 1px solid #e0c052 !important;
      border-radius: 4px !important;
      background-color: #ffffff !important;
      color: #40312a !important;
      font-size: 14px !important;
      min-width: 150px !important;
    }
    
    .location-filter-select:hover {
      border-color: #d4b847 !important;
    }
    
    .location-filter-select:focus {
      outline: none !important;
      border-color: #8A4A19 !important;
      box-shadow: 0 0 0 2px rgba(138, 74, 25, 0.2) !important;
    }
    
    .location-filter-counter {
      color: #8A4A19 !important;
      font-weight: 500 !important;
      font-size: 14px !important;
    }
    
    /* Estilos para la tabla completa */
    .admin-users-table table,
    .admin-users table,
    .users-table table,
    .admin-users-list table,
    .admin-users-list,
    .directory-table {
      border-collapse: collapse !important;
    }
    
    .admin-users-table th,
    .admin-users-table td,
    .admin-users th,
    .admin-users td,
    .users-table th,
    .users-table td,
    .admin-users-list th,
    .admin-users-list td,
    .directory-table__column-header,
    .directory-table__cell {
    }
  `;
  document.head.appendChild(style);
}

// FunciÃ³n para limpiar la columna cuando se cambia de pÃ¡gina
function cleanupLocationColumn() {
  const existingHeader = document.querySelector('.location-column-header');
  const existingCells = document.querySelectorAll('.location-column-data');
  const existingStyle = document.querySelector('style[data-location-column]');
  const existingFilter = document.querySelector('.location-filter-container');
  
  if (existingHeader) existingHeader.remove();
  existingCells.forEach(cell => cell.remove());
  if (existingStyle) existingStyle.remove();
  if (existingFilter) existingFilter.remove();
}

// FunciÃ³n principal que se ejecuta cuando Discourse estÃ© listo
async function initLocationColumn() {
  try {
    // Esperar a que Discourse estÃ© completamente cargado
    await waitForDiscourse();
    
    console.log('ğŸš€ Inicializando columna Location...');
    
    // Ejecutar cuando se carga la pÃ¡gina
    await addLocationColumn();
    
    // Ejecutar cuando cambia la URL (navegaciÃ³n SPA de Discourse)
    let currentUrl = window.location.href;
    const observer = new MutationObserver(function() {
      if (window.location.href !== currentUrl) {
        currentUrl = window.location.href;
        
        // Limpiar columna anterior
        cleanupLocationColumn();
        
        // Agregar nueva columna
        setTimeout(addLocationColumn, 1000);
      }
    });
    
    observer.observe(document.body, {
      childList: true,
      subtree: true
    });
    
    // TambiÃ©n ejecutar cuando se hace clic en enlaces de navegaciÃ³n
    document.addEventListener('click', function(event) {
      const target = event.target.closest('a');
      if (target && target.href) {
        const href = target.href;
        const isAdminUsersLink = href.includes('/admin/users/list/');
        const isPublicUsersLink = href.includes('/u') && (href.includes('order=') || href.endsWith('/u'));
        
        if (isAdminUsersLink || isPublicUsersLink) {
          setTimeout(() => {
            cleanupLocationColumn();
            addLocationColumn();
          }, 1000);
        }
      }
    });
    
    // Ejecutar cuando se cambia entre pestaÃ±as (Active, New, Staff, etc.) o ordenamientos pÃºblicos
    document.addEventListener('click', function(event) {
      const target = event.target.closest('a');
      if (target && target.classList.contains('ember-view')) {
        const href = target.getAttribute('href');
        if (href && (href.includes('/admin/users/list/') || href.includes('/admin/groups') || (href.includes('/u') && (href.includes('order=') || href.endsWith('/u'))))) {
          setTimeout(() => {
            cleanupLocationColumn();
            addLocationColumn();
          }, 1500);
        }
      }
    });
    
    console.log('ğŸš€ Columna Location inicializada correctamente');
    
  } catch (error) {
    console.log('âŒ Error inicializando columna Location:', error);
  }
}

// Iniciar cuando el DOM estÃ© listo
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initLocationColumn);
} else {
  initLocationColumn();
}
</script>
