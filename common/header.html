<script type="text/javascript">
// Discourse Admin Users Location Column
// Este script agrega una columna "Location" a la vista de administraci√≥n de usuarios

// Funci√≥n para esperar a que Discourse est√© completamente cargado
function waitForDiscourse() {
  return new Promise((resolve) => {
    if (window.Discourse && window.Discourse.__container__) {
      resolve();
    } else {
      const checkInterval = setInterval(() => {
        if (window.Discourse && window.Discourse.__container__) {
          clearInterval(checkInterval);
          resolve();
        }
      }, 100);
    }
  });
}

// Funci√≥n para esperar a que un elemento est√© disponible en el DOM
function waitForElement(selector, timeout = 10000) {
  return new Promise((resolve, reject) => {
    const element = document.querySelector(selector);
    if (element) {
      resolve(element);
      return;
    }

    const observer = new MutationObserver((mutations, obs) => {
      const element = document.querySelector(selector);
      if (element) {
        obs.disconnect();
        resolve(element);
      }
    });

    observer.observe(document.body, {
      childList: true,
      subtree: true
    });

    // Timeout despu√©s de 10 segundos
    setTimeout(() => {
      observer.disconnect();
      reject(new Error(`Elemento ${selector} no encontrado despu√©s de ${timeout}ms`));
    }, timeout);
  });
}

// Funci√≥n para encontrar la tabla de usuarios de administraci√≥n
function findAdminUsersTable() {
  // Intentar diferentes selectores para encontrar la tabla
  const selectors = [
    '.admin-users-table table',
    '.admin-users table',
    '.users-table table',
    'table.admin-users-table',
    'table.admin-users',
    'table.users-table',
    '.admin-users-list table',
    '.admin-users-list',
    'table[data-table-name="admin-users"]',
    'table[data-table-name="users"]',
    // Selectores m√°s gen√©ricos
    'table thead th:contains("Username")',
    'table thead th:contains("Name")',
    'table thead th:contains("Email")',
    // Buscar por contenido de la tabla
    'table:has(th:contains("Username"))',
    'table:has(th:contains("Name"))',
    'table:has(th:contains("Email"))'
  ];

  for (const selector of selectors) {
    try {
      const element = document.querySelector(selector);
      if (element) {
        console.log(`‚úÖ Tabla encontrada con selector: ${selector}`);
        return element;
      }
    } catch (e) {
      // Ignorar errores de selectores inv√°lidos
    }
  }

  // Si no se encuentra con selectores espec√≠ficos, buscar por contenido
  const allTables = document.querySelectorAll('table');
  for (const table of allTables) {
    const thead = table.querySelector('thead');
    if (thead) {
      const headers = thead.querySelectorAll('th');
      let hasUsername = false;
      let hasEmail = false;
      
      for (const header of headers) {
        const text = header.textContent.toLowerCase();
        if (text.includes('username') || text.includes('name')) {
          hasUsername = true;
        }
        if (text.includes('email')) {
          hasEmail = true;
        }
      }
      
      if (hasUsername && hasEmail) {
        console.log('‚úÖ Tabla encontrada por contenido (username + email)');
        return table;
      }
    }
  }

  return null;
}

// Funci√≥n para agregar event listeners de manera compatible
function addEventListenerSafe(element, event, handler) {
  if (element && typeof element.addEventListener === 'function') {
    element.addEventListener(event, handler);
  }
}

// Cache para almacenar las ubicaciones de los usuarios
const userLocationCache = new Map();

// Funci√≥n para obtener la ubicaci√≥n de un usuario desde la API
async function getUserLocation(username) {
  if (userLocationCache.has(username)) {
    return userLocationCache.get(username);
  }
  
  try {
    // Hacer una llamada a la API de Discourse para obtener el perfil del usuario
    const response = await fetch(`/u/${username}.json`, {
      method: 'GET',
      headers: {
        'Accept': 'application/json',
        'X-Requested-With': 'XMLHttpRequest'
      }
    });
    
    if (response.ok) {
      const userData = await response.json();
      let location = 'N/A';
      
      // Buscar la ubicaci√≥n en los campos del usuario
      if (userData.user && userData.user.user_fields) {
        // Buscar en campos personalizados (user_fields)
        for (let i = 1; i <= 20; i++) {
          const fieldKey = `user_field_${i}`;
          if (userData.user.user_fields[fieldKey]) {
            const fieldValue = userData.user.user_fields[fieldKey];
            // Buscar si contiene informaci√≥n de ubicaci√≥n
            if (fieldValue && typeof fieldValue === 'string' && 
                (fieldValue.toLowerCase().includes('location') || 
                 fieldValue.toLowerCase().includes('ubicaci√≥n') ||
                 fieldValue.toLowerCase().includes('city') ||
                 fieldValue.toLowerCase().includes('country'))) {
              location = fieldValue;
              break;
            }
          }
        }
      }
      
      // Si no se encontr√≥ en user_fields, buscar en otros campos
      if (location === 'N/A' && userData.user) {
        // Buscar en el campo "location" est√°ndar de Discourse
        if (userData.user.location) {
          location = userData.user.location;
        }
        // Buscar en el campo "bio" o "about"
        else if (userData.user.bio_excerpt && userData.user.bio_excerpt.includes('Location:')) {
          const bioMatch = userData.user.bio_excerpt.match(/Location:\s*([^\n]+)/i);
          if (bioMatch) {
            location = bioMatch[1].trim();
          }
        }
      }
      
      // Guardar en cache
      userLocationCache.set(username, location);
      return location;
    }
  } catch (error) {
    console.log('Error obteniendo ubicaci√≥n del usuario:', error);
  }
  
  // Si falla, guardar N/A en cache para evitar reintentos
  userLocationCache.set(username, 'N/A');
  return 'N/A';
}

// Funci√≥n para agregar la columna Location
async function addLocationColumn() {
  try {
    // Verificar si estamos en la p√°gina de administraci√≥n de usuarios
    if (!window.location.pathname.includes('/admin/users/list/')) {
      console.log('üìç No estamos en la p√°gina de administraci√≥n de usuarios');
      return;
    }
    
    console.log('üîç Buscando tabla de usuarios...');
    
    // Esperar un poco m√°s para que la p√°gina se cargue completamente
    await new Promise(resolve => setTimeout(resolve, 2000));
    
    // Buscar la tabla usando nuestra funci√≥n personalizada
    const table = findAdminUsersTable();
    if (!table) {
      console.log('‚ùå No se pudo encontrar la tabla de usuarios');
      // Intentar de nuevo en unos segundos
      setTimeout(addLocationColumn, 3000);
      return;
    }
    
    const thead = table.querySelector('thead tr');
    const tbody = table.querySelector('tbody');
    
    if (!thead || !tbody) {
      console.log('‚ùå No se encontr√≥ thead o tbody en la tabla');
      return;
    }
    
    // Verificar si ya se agreg√≥ la columna
    if (thead.querySelector('.location-column-header')) {
      console.log('‚úÖ La columna Location ya est√° presente');
      return;
    }
    
    console.log('üìä Agregando columna Location...');
    
    // Agregar encabezado de columna
    const locationHeader = document.createElement('th');
    locationHeader.className = 'location-column-header';
    locationHeader.textContent = 'Location';
    locationHeader.style.minWidth = '120px';
    locationHeader.style.textAlign = 'center';
    
    // Insertar despu√©s de la columna "Last Posted" o antes de la √∫ltima columna
    const lastPostedHeader = thead.querySelector('th:last-child');
    if (lastPostedHeader) {
      thead.insertBefore(locationHeader, lastPostedHeader);
    } else {
      thead.appendChild(locationHeader);
    }
    
    // Agregar celdas de datos para cada fila
    const rows = tbody.querySelectorAll('tr');
    console.log(`üìù Agregando celdas para ${rows.length} filas...`);
    
    rows.forEach(function(row, index) {
      const locationCell = document.createElement('td');
      locationCell.className = 'location-column-data';
      locationCell.style.textAlign = 'center';
      locationCell.style.verticalAlign = 'middle';
      
      // Obtener el username de la fila
      const usernameLink = row.querySelector('td:first-child a');
      if (usernameLink) {
        const username = usernameLink.textContent.trim();
        
        // Mostrar "Cargando..." inicialmente
        locationCell.textContent = 'Cargando...';
        locationCell.style.fontStyle = 'italic';
        locationCell.style.color = '#666';
        
        // Obtener la ubicaci√≥n del usuario
        getUserLocation(username).then(location => {
          locationCell.textContent = location;
          locationCell.style.fontStyle = 'normal';
          locationCell.style.color = '#40312a';
          
          // Aplicar estilos especiales para ubicaciones v√°lidas
          if (location !== 'N/A') {
            locationCell.style.fontWeight = '500';
            locationCell.style.color = '#8A4A19';
          }
        });
      } else {
        locationCell.textContent = 'N/A';
      }
      
      // Insertar la celda en la posici√≥n correcta
      const lastCell = row.querySelector('td:last-child');
      if (lastCell) {
        row.insertBefore(locationCell, lastCell);
      } else {
        row.appendChild(locationCell);
      }
    });
    
    // Aplicar estilos CSS personalizados
    const style = document.createElement('style');
    style.setAttribute('data-location-column', 'true');
    style.textContent = `
      .location-column-header {
        background-color: #f4d35e !important;
        color: #40312a !important;
        font-weight: 600 !important;
        border: 1px solid #e0c052 !important;
        padding: 8px 12px !important;
        text-align: center !important;
        vertical-align: middle !important;
      }
      
      .location-column-data {
        background-color: #faf0ca !important;
        border: 1px solid #eadac9 !important;
        color: #40312a !important;
        font-size: 0.9em !important;
        padding: 8px 12px !important;
        text-align: center !important;
        vertical-align: middle !important;
        transition: all 0.2s ease !important;
      }
      
      .location-column-data:hover {
        background-color: #f0c052 !important;
        color: #212121 !important;
        transform: scale(1.02) !important;
      }
      
      /* Estilos para la tabla completa */
      .admin-users-table table,
      .admin-users table,
      .users-table table {
        border-collapse: collapse !important;
      }
      
      .admin-users-table th,
      .admin-users-table td,
      .admin-users th,
      .admin-users td,
      .users-table th,
      .users-table td {
        border: 1px solid #eadac9 !important;
      }
    `;
    document.head.appendChild(style);
    
    console.log('‚úÖ Columna Location agregada exitosamente');
    
  } catch (error) {
    console.log('‚ùå Error agregando columna Location:', error);
    // Intentar de nuevo en unos segundos
    setTimeout(addLocationColumn, 3000);
  }
}

// Funci√≥n para limpiar la columna cuando se cambia de p√°gina
function cleanupLocationColumn() {
  const existingHeader = document.querySelector('.location-column-header');
  const existingCells = document.querySelectorAll('.location-column-data');
  const existingStyle = document.querySelector('style[data-location-column]');
  
  if (existingHeader) existingHeader.remove();
  existingCells.forEach(cell => cell.remove());
  if (existingStyle) existingStyle.remove();
}

// Funci√≥n principal que se ejecuta cuando Discourse est√© listo
async function initLocationColumn() {
  try {
    // Esperar a que Discourse est√© completamente cargado
    await waitForDiscourse();
    
    console.log('üöÄ Inicializando columna Location...');
    
    // Ejecutar cuando se carga la p√°gina
    await addLocationColumn();
    
    // Ejecutar cuando cambia la URL (navegaci√≥n SPA de Discourse)
    let currentUrl = window.location.href;
    const observer = new MutationObserver(function() {
      if (window.location.href !== currentUrl) {
        currentUrl = window.location.href;
        
        // Limpiar columna anterior
        cleanupLocationColumn();
        
        // Agregar nueva columna
        setTimeout(addLocationColumn, 1000);
      }
    });
    
    observer.observe(document.body, {
      childList: true,
      subtree: true
    });
    
    // Tambi√©n ejecutar cuando se hace clic en enlaces de navegaci√≥n
    document.addEventListener('click', function(event) {
      const target = event.target.closest('a');
      if (target && target.href && target.href.includes('/admin/users/list/')) {
        setTimeout(() => {
          cleanupLocationColumn();
          addLocationColumn();
        }, 1000);
      }
    });
    
    // Ejecutar cuando se cambia entre pesta√±as (Active, New, Staff, etc.)
    document.addEventListener('click', function(event) {
      const target = event.target.closest('a');
      if (target && target.classList.contains('ember-view')) {
        const href = target.getAttribute('href');
        if (href && (href.includes('/admin/users/list/') || href.includes('/admin/groups'))) {
          setTimeout(() => {
            cleanupLocationColumn();
            addLocationColumn();
          }, 1500);
        }
      }
    });
    
    console.log('üöÄ Columna Location inicializada correctamente');
    
  } catch (error) {
    console.log('‚ùå Error inicializando columna Location:', error);
  }
}

// Iniciar cuando el DOM est√© listo
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initLocationColumn);
} else {
  initLocationColumn();
}
</script>
