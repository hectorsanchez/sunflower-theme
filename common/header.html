<script type="text/javascript">
// Discourse Admin Users Location Column
// Este script agrega una columna "Location" a la vista de administraci√≥n de usuarios

// Funci√≥n para esperar a que Discourse est√© completamente cargado
function waitForDiscourse() {
  return new Promise((resolve) => {
    if (window.Discourse && window.Discourse.__container__) {
      resolve();
    } else {
      const checkInterval = setInterval(() => {
        if (window.Discourse && window.Discourse.__container__) {
          clearInterval(checkInterval);
          resolve();
        }
      }, 100);
    }
  });
}

// Funci√≥n para esperar a que un elemento est√© disponible en el DOM
function waitForElement(selector, timeout = 10000) {
  return new Promise((resolve, reject) => {
    const element = document.querySelector(selector);
    if (element) {
      resolve(element);
      return;
    }

    const observer = new MutationObserver((mutations, obs) => {
      const element = document.querySelector(selector);
      if (element) {
        obs.disconnect();
        resolve(element);
      }
    });

    observer.observe(document.body, {
      childList: true,
      subtree: true
    });

    // Timeout despu√©s de 10 segundos
    setTimeout(() => {
      observer.disconnect();
      reject(new Error(`Elemento ${selector} no encontrado despu√©s de ${timeout}ms`));
    }, timeout);
  });
}

// Funci√≥n para encontrar la tabla de usuarios (admin o p√∫blica)
function findUsersTable() {
  // Intentar diferentes selectores para encontrar la tabla
  const selectors = [
    '.directory-table.users-list',
    '.directory-table[role="table"]',
    '.directory-table', // Para vista p√∫blica
    '.users-list',
    '.admin-users-list',
    '.admin-users table',
    '.admin-users-table table',
    'table.admin-users-table',
    'table.admin-users',
    'table.users-table'
  ];

  for (const selector of selectors) {
    try {
      const element = document.querySelector(selector);
      if (element) {
        console.log(`‚úÖ Tabla encontrada con selector: ${selector}`);
        return element;
      }
    } catch (e) {
      // Ignorar errores de selectores inv√°lidos
    }
  }

  // Si no se encuentra con selectores espec√≠ficos, buscar por contenido
  const allTables = document.querySelectorAll('[role="table"], table');
  for (const table of allTables) {
    const headers = table.querySelectorAll('[role="columnheader"], th');
    let hasUsername = false;
    let hasEmail = false;
    
    for (const header of headers) {
      const text = header.textContent.toLowerCase();
      if (text.includes('username') || text.includes('name')) {
        hasUsername = true;
      }
      if (text.includes('email')) {
        hasEmail = true;
      }
    }
    
    if (hasUsername && hasEmail) {
      console.log('‚úÖ Tabla encontrada por contenido (username + email)');
      return table;
    }
  }

  return null;
}

// Funci√≥n para analizar la estructura de la tabla encontrada
function analyzeTableStructure(table) {
  // Verificar si es una tabla moderna de Discourse (CSS Grid + ARIA)
  if (table.classList.contains('directory-table') || table.getAttribute('role') === 'table') {
    
    // Buscar encabezados de columna
    const columnHeaders = table.querySelectorAll('.directory-table__column-header, [role="columnheader"]');
    if (columnHeaders.length > 0) {
      
      // Buscar filas de datos
      const dataRows = table.querySelectorAll('.directory-table__row, [role="row"]:not([role="columnheader"])');
      
      return { 
        type: 'modern', 
        table, 
        columnHeaders: Array.from(columnHeaders), 
        dataRows: Array.from(dataRows) 
      };
    }
  }
  
  // Verificar si tiene thead/tbody tradicional
  const thead = table.querySelector('thead');
  const tbody = table.querySelector('tbody');
  
  if (thead && tbody) {
    console.log('‚úÖ Estructura tradicional: thead + tbody');
    return { type: 'traditional', thead, tbody };
  }
  
  // Si no tiene thead/tbody, buscar filas directamente
  const allRows = table.querySelectorAll('tr');
  if (allRows.length > 0) {
    console.log(`üìä Encontradas ${allRows.length} filas en la tabla`);
    
    // La primera fila suele ser el encabezado
    const headerRow = allRows[0];
    const dataRows = Array.from(allRows).slice(1);
    
    console.log('‚úÖ Estructura alternativa: filas directas');
    return { type: 'alternative', headerRow, dataRows, allRows };
  }
  
  // Si no hay filas, buscar en elementos hijos
  const childElements = table.children;

  
  return null;
}

// Funci√≥n para agregar event listeners de manera compatible
function addEventListenerSafe(element, event, handler) {
  if (element && typeof element.addEventListener === 'function') {
    element.addEventListener(event, handler);
  }
}

// Cache para almacenar las ubicaciones de los usuarios (persistente)
const userLocationCache = new Map();

// Configuraci√≥n de rate limiting
const RATE_LIMIT_CONFIG = {
  maxConcurrent: 3,        // M√°ximo 3 llamadas simult√°neas
  delayBetweenBatches: 1000, // 1 segundo entre lotes
  batchSize: 5,            // Procesar 5 usuarios por lote
  maxRetries: 3,           // M√°ximo 3 reintentos
  retryDelay: 2000         // 2 segundos base para retry
};

// Cola de usuarios pendientes de procesar
const pendingUsersQueue = [];
let activeRequests = 0;

// Cargar cache desde localStorage al iniciar
function loadCacheFromStorage() {
  try {
    const stored = localStorage.getItem('userLocationCache');
    if (stored) {
      const cacheData = JSON.parse(stored);
      Object.entries(cacheData).forEach(([key, value]) => {
        userLocationCache.set(key, value);
      });
      console.log(`üì¶ Cache cargado: ${userLocationCache.size} ubicaciones`);
    }
  } catch (error) {
    console.log('‚ö†Ô∏è Error cargando cache desde localStorage:', error);
  }
}

// Guardar cache en localStorage
function saveCacheToStorage() {
  try {
    const cacheData = Object.fromEntries(userLocationCache);
    localStorage.setItem('userLocationCache', JSON.stringify(cacheData));
  } catch (error) {
    console.log('‚ö†Ô∏è Error guardando cache en localStorage:', error);
  }
}

// Funci√≥n para obtener la ubicaci√≥n de un usuario desde la API con rate limiting
async function getUserLocation(username) {
  // Verificar cache primero
  if (userLocationCache.has(username)) {
    return userLocationCache.get(username);
  }
  
  // Si ya est√° en la cola, esperar
  if (pendingUsersQueue.some(item => item.username === username)) {
    return new Promise((resolve) => {
      const checkInterval = setInterval(() => {
        if (userLocationCache.has(username)) {
          clearInterval(checkInterval);
          resolve(userLocationCache.get(username));
        }
      }, 100);
    });
  }
  
  // Agregar a la cola
  return new Promise((resolve) => {
    pendingUsersQueue.push({ username, resolve });
    processUserQueue();
  });
}

// Funci√≥n para procesar la cola de usuarios con rate limiting
async function processUserQueue() {
  if (activeRequests >= RATE_LIMIT_CONFIG.maxConcurrent || pendingUsersQueue.length === 0) {
    return;
  }
  
  // Tomar un lote de usuarios
  const batch = pendingUsersQueue.splice(0, RATE_LIMIT_CONFIG.batchSize);
  activeRequests++;
  
  console.log(`üîÑ Procesando lote de ${batch.length} usuarios (${pendingUsersQueue.length} pendientes)`);
  
  // Procesar el lote
  const promises = batch.map(item => fetchUserLocationWithRetry(item.username));
  
  try {
    await Promise.all(promises);
  } catch (error) {
    console.log('‚ö†Ô∏è Error procesando lote:', error);
  }
  
  // Resolver las promesas pendientes
  batch.forEach(item => {
    const location = userLocationCache.get(item.username) || 'N/A';
    item.resolve(location);
  });
  
  activeRequests--;
  
  // Esperar antes del siguiente lote
  if (pendingUsersQueue.length > 0) {
    setTimeout(() => {
      processUserQueue();
    }, RATE_LIMIT_CONFIG.delayBetweenBatches);
  }
}

// Funci√≥n para obtener ubicaci√≥n con retry y backoff exponencial
async function fetchUserLocationWithRetry(username, retryCount = 0) {
  try {
    console.log(`üîç Obteniendo ubicaci√≥n para: ${username} (intento ${retryCount + 1})`);
    
    const apiUrl = `/u/${username}.json`;
    const response = await fetch(apiUrl, {
      method: 'GET',
      headers: {
        'Accept': 'application/json',
        'X-Requested-With': 'XMLHttpRequest'
      }
    });
    
    if (response.ok) {
      const userData = await response.json();
      let location = 'N/A';
      
      // Verificar si tenemos datos del usuario
      if (!userData.user) {
        userLocationCache.set(username, 'N/A');
        saveCacheToStorage();
        return 'N/A';
      }
      
      // Buscar la ubicaci√≥n en el campo "location" est√°ndar
      if (userData.user.location) {
        location = userData.user.location;
      }
      
      // Si no se encontr√≥ en location est√°ndar, buscar en campos personalizados
      if (location === 'N/A' && userData.user.user_fields) {
        for (let i = 1; i <= 20; i++) {
          const fieldKey = `user_field_${i}`;
          if (userData.user.user_fields[fieldKey]) {
            const fieldValue = userData.user.user_fields[fieldKey];
            if (fieldValue && typeof fieldValue === 'string' && 
                (fieldValue.toLowerCase().includes('location') || 
                 fieldValue.toLowerCase().includes('ubicaci√≥n') ||
                 fieldValue.toLowerCase().includes('city') ||
                 fieldValue.toLowerCase().includes('country') ||
                 fieldValue.toLowerCase().includes('pa√≠s') ||
                 fieldValue.toLowerCase().includes('ciudad'))) {
              location = fieldValue;
              break;
            }
          }
        }
      }
      
      // Extraer el pa√≠s si se encontr√≥ ubicaci√≥n
      if (location !== 'N/A') {
        const country = extractCountryFromLocation(location);
        location = country;
      }
      
      // Guardar en cache
      userLocationCache.set(username, location);
      saveCacheToStorage();
      return location;
      
    } else if (response.status === 429 && retryCount < RATE_LIMIT_CONFIG.maxRetries) {
      // Rate limit - esperar con backoff exponencial
      const delay = RATE_LIMIT_CONFIG.retryDelay * Math.pow(2, retryCount);
      console.log(`‚è≥ Rate limit alcanzado para ${username}, reintentando en ${delay}ms`);
      
      await new Promise(resolve => setTimeout(resolve, delay));
      return fetchUserLocationWithRetry(username, retryCount + 1);
      
    } else {
      console.log(`‚ùå Error ${response.status} para usuario ${username}`);
      userLocationCache.set(username, 'N/A');
      saveCacheToStorage();
      return 'N/A';
    }
    
  } catch (error) {
    console.log(`‚ùå Error obteniendo ubicaci√≥n para ${username}:`, error);
    
    if (retryCount < RATE_LIMIT_CONFIG.maxRetries) {
      const delay = RATE_LIMIT_CONFIG.retryDelay * Math.pow(2, retryCount);
      console.log(`üîÑ Reintentando ${username} en ${delay}ms`);
      
      await new Promise(resolve => setTimeout(resolve, delay));
      return fetchUserLocationWithRetry(username, retryCount + 1);
    } else {
      userLocationCache.set(username, 'N/A');
      saveCacheToStorage();
      return 'N/A';
    }
  }
}

// Inicializar cache al cargar
loadCacheFromStorage();

// Funci√≥n para extraer el pa√≠s de la ubicaci√≥n (basada en tu script de Python)
function extractCountryFromLocation(location) {
  if (!location || location === 'N/A') {
    return 'Sin ubicaci√≥n';
  }

  // Si la ubicaci√≥n contiene una coma, tomar la √∫ltima parte (pa√≠s)
  if (location.includes(',')) {
    const parts = location.split(',');
    const country = parts[parts.length - 1].trim();
    return country;
  }

  // Si no hay coma, asumir que es solo el pa√≠s
  return location.trim();
}

// Funci√≥n para agregar la columna Location
async function addLocationColumn() {
  try {
    // Verificar si estamos en una p√°gina de usuarios (admin o p√∫blica)
    const isAdminUsersPage = window.location.pathname.includes('/admin/users/list/');
    const isPublicUsersPage = window.location.pathname.includes('/u') && 
      (window.location.search.includes('order=') || window.location.pathname === '/u');
    
    if (!isAdminUsersPage && !isPublicUsersPage) {
      return;
    }
    
    // Esperar un poco m√°s para que la p√°gina se cargue completamente
    await new Promise(resolve => setTimeout(resolve, 2000));
    
    // Buscar la tabla usando nuestra funci√≥n personalizada
    const table = findUsersTable();
    if (!table) {
      // Intentar de nuevo en unos segundos
      setTimeout(addLocationColumn, 3000);
      return;
    }
    
    // Analizar la estructura de la tabla
    const structure = analyzeTableStructure(table);
    if (!structure) {
      return;
    }
    
    // Verificar si ya se agreg√≥ la columna
    if (table.querySelector('.location-column-header')) {
      return;
    }
    
    if (structure.type === 'modern') {
      // Estructura moderna de Discourse (CSS Grid + ARIA)
      await addColumnToModernTable(structure.table, structure.columnHeaders, structure.dataRows);
    } else if (structure.type === 'traditional') {
      // Estructura tradicional con thead/tbody
      await addColumnToTraditionalTable(structure.thead, structure.tbody);
    } else if (structure.type === 'alternative') {
      // Estructura alternativa con filas directas
      await addColumnToAlternativeTable(structure.headerRow, structure.dataRows);
    }
    
    // Aplicar estilos CSS personalizados
    applyLocationColumnStyles();
    
  } catch (error) {
    // Intentar de nuevo en unos segundos
    setTimeout(addLocationColumn, 3000);
  }
}

// Funci√≥n para agregar columna a tabla moderna de Discourse
async function addColumnToModernTable(table, columnHeaders, dataRows) {

  
  // Crear encabezado de columna
  const locationHeader = document.createElement('div');
  locationHeader.className = 'directory-table__column-header location-column-header sortable';
  locationHeader.setAttribute('aria-sort', 'none');
  locationHeader.setAttribute('role', 'columnheader');
  
  const headerContents = document.createElement('div');
  headerContents.className = 'header-contents';
  headerContents.setAttribute('role', 'button');
  headerContents.setAttribute('tabindex', '0');
  headerContents.setAttribute('aria-label', 'Location');
  headerContents.setAttribute('aria-pressed', 'false');
  
  const textSpan = document.createElement('span');
  textSpan.className = 'text';
  textSpan.textContent = 'Location';
  
  headerContents.appendChild(textSpan);
  locationHeader.appendChild(headerContents);
  
  // Insertar el encabezado antes del √∫ltimo encabezado existente
  if (columnHeaders.length > 0) {
    const lastHeader = columnHeaders[columnHeaders.length - 1];
    lastHeader.parentNode.insertBefore(locationHeader, lastHeader.nextSibling);
  } else {
    // Si no hay encabezados, insertar en el contenedor de encabezados
    const headerContainer = table.querySelector('.directory-table__header');
    if (headerContainer) {
      headerContainer.appendChild(locationHeader);
    }
  }
  
  // Agregar celdas de datos
  for (const row of dataRows) {
    await addLocationCellToModernRow(row);
  }
  
  // Actualizar el CSS Grid para incluir la nueva columna
  updateGridColumns(table);
  
  // Agregar filtro por ubicaci√≥n
  await addLocationFilter(table, dataRows);
}

// Funci√≥n para agregar celda de ubicaci√≥n a una fila moderna
async function addLocationCellToModernRow(row) {
  const locationCell = document.createElement('div');
  locationCell.className = 'directory-table__cell location-column-data';
  locationCell.setAttribute('role', 'cell');
  
  // Obtener el username de la fila
  const usernameCell = row.querySelector('.directory-table__cell.username');
  let username = '';
  
  if (usernameCell) {
    // Buscar el enlace del username (el segundo enlace con clase ember-view)
    const usernameLink = usernameCell.querySelector('a.ember-view');
    
    if (usernameLink) {
      username = usernameLink.textContent.trim();
    } else {
      // Intentar otros selectores para la vista p√∫blica
      const avatarLink = usernameCell.querySelector('a.avatar');
      if (avatarLink) {
        const href = avatarLink.getAttribute('href');
        if (href && href.startsWith('/u/')) {
          username = href.split('/u/')[1];
        }
      }
      
      if (!username) {
        username = usernameCell.textContent.trim();
      }
    }
  } else {
    // Intentar otros selectores para la vista p√∫blica
    const allCells = row.querySelectorAll('.directory-table__cell');
    
    for (const cell of allCells) {
      const links = cell.querySelectorAll('a');
      for (const link of links) {
        const href = link.getAttribute('href');
        if (href && href.startsWith('/u/')) {
          username = href.split('/u/')[1];
          break;
        }
      }
      if (username) break;
    }
  }
  
  if (username) {
    // Verificar si ya est√° en cache
    if (userLocationCache.has(username)) {
      const location = userLocationCache.get(username);
      locationCell.textContent = location;
      locationCell.style.fontStyle = 'normal';
      locationCell.style.color = '#40312a';
      
      if (location !== 'N/A') {
        locationCell.style.fontWeight = '500';
        locationCell.style.color = '#8A4A19';
      }
    } else {
      // Mostrar indicador de carga con progreso
      locationCell.innerHTML = '<span class="loading-indicator">‚è≥ En cola...</span>';
      locationCell.style.fontStyle = 'italic';
      locationCell.style.color = '#666';
      locationCell.style.fontSize = '0.85em';
      
      // Obtener la ubicaci√≥n del usuario
      getUserLocation(username).then(location => {
        locationCell.textContent = location;
        locationCell.style.fontStyle = 'normal';
        locationCell.style.color = '#40312a';
        locationCell.style.fontSize = '0.9em';
        
        // Aplicar estilos especiales para ubicaciones v√°lidas
        if (location !== 'N/A') {
          locationCell.style.fontWeight = '500';
          locationCell.style.color = '#8A4A19';
        }
      });
    }
  } else {
    locationCell.textContent = 'N/A';
  }
  
  // Insertar la celda en la posici√≥n correcta
  const lastCell = row.querySelector('.directory-table__cell:last-child');
  if (lastCell) {
    row.insertBefore(locationCell, lastCell.nextSibling);
  } else {
    row.appendChild(locationCell);
  }
}

// Funci√≥n para actualizar las columnas del CSS Grid
function updateGridColumns(table) {
  const currentStyle = table.style.gridTemplateColumns;
  if (currentStyle) {
    // Agregar una columna m√°s al grid
    const newStyle = currentStyle.replace(/\)$/, ' minmax(min-content, 1fr))');
    table.style.gridTemplateColumns = newStyle;
    console.log('üîß CSS Grid actualizado para incluir la nueva columna');
  }
}

// Funci√≥n para agregar filtro por ubicaci√≥n
async function addLocationFilter(table, dataRows) {
  console.log('üîç Agregando filtro por ubicaci√≥n...');
  
  // Crear el contenedor del filtro
  const filterContainer = document.createElement('div');
  filterContainer.className = 'location-filter-container';
  filterContainer.style.cssText = `
    margin: 10px 0;
    padding: 10px;
    background-color: var(--bg-tertiary);
    border: 1px solid var(--border-primary);
    border-radius: 4px;
    display: flex;
    align-items: center;
    gap: 10px;
    flex-wrap: wrap;
  `;
  
  // Crear etiqueta
  const label = document.createElement('label');
  label.textContent = 'Filter by Location:';
  label.style.cssText = `
    font-weight: 600;
    color: var(--text-primary);
    margin-right: 5px;
  `;
  
  // Crear dropdown
  const select = document.createElement('select');
  select.className = 'location-filter-select';
  select.style.cssText = `
    padding: 5px 10px;
    border: 1px solid #e0c052;
    border-radius: 4px;
    background-color: var(--bg-primary);
    color: var(--text-primary);
    font-size: 14px;
    min-width: 150px;
  `;
  
  // Agregar opciones iniciales
  const allOption = document.createElement('option');
  allOption.value = 'all';
  allOption.textContent = 'All users';
  select.appendChild(allOption);
  
  const noLocationOption = document.createElement('option');
  noLocationOption.value = 'no-location';
  noLocationOption.textContent = 'No location';
  select.appendChild(noLocationOption);
  
  // Crear contador
  const counter = document.createElement('span');
  counter.className = 'location-filter-counter';
  counter.style.cssText = `
    color: var(--text-secondary);
    font-weight: 500;
    font-size: 14px;
  `;
  
  // Crear indicador de progreso
  const progressIndicator = document.createElement('span');
  progressIndicator.className = 'location-progress-indicator';
  progressIndicator.style.cssText = `
    color: var(--text-secondary);
    font-size: 12px;
    font-style: italic;
  `;
  progressIndicator.textContent = 'Cargando ubicaciones...';
  
  // Funci√≥n para actualizar el contador
  function updateCounter() {
    const visibleRows = table.querySelectorAll('.directory-table__row:not([style*="display: none"])');
    const totalRows = dataRows.length;
    counter.textContent = `${visibleRows.length} of ${totalRows} users`;
  }
  
  // Funci√≥n para actualizar el filtro con nuevas ubicaciones
  function updateLocationOptions() {
    const locations = new Set();
    const locationCells = table.querySelectorAll('.location-column-data');
    
    locationCells.forEach(cell => {
      const location = cell.textContent.trim();
      if (location && location !== 'Cargando...' && location !== '‚è≥ En cola...' && location !== 'N/A') {
        locations.add(location);
      }
    });
    
    // Limpiar opciones existentes (excepto las primeras dos)
    while (select.children.length > 2) {
      select.removeChild(select.lastChild);
    }
    
    // Agregar opciones de ubicaciones
    const sortedLocations = Array.from(locations).sort();
    sortedLocations.forEach(location => {
      const option = document.createElement('option');
      option.value = location;
      option.textContent = location;
      select.appendChild(option);
    });
    
    // Ocultar indicador de progreso si hay ubicaciones
    if (locations.size > 0) {
      progressIndicator.style.display = 'none';
    }
  }
  
  // Funci√≥n para filtrar
  function filterByLocation(selectedLocation) {
    console.log(`üîç Filtrando por ubicaci√≥n: ${selectedLocation}`);
    
    dataRows.forEach(row => {
      const locationCell = row.querySelector('.location-column-data');
      if (locationCell) {
        const cellLocation = locationCell.textContent.trim();
        
        if (selectedLocation === 'all') {
          row.style.display = '';
        } else if (selectedLocation === 'no-location') {
          row.style.display = (cellLocation === 'N/A' || cellLocation === 'Cargando...' || cellLocation === '‚è≥ En cola...') ? '' : 'none';
        } else {
          row.style.display = (cellLocation === selectedLocation) ? '' : 'none';
        }
      }
    });
    
    updateCounter();
  }
  
  // Event listener para el filtro
  select.addEventListener('change', (e) => {
    filterByLocation(e.target.value);
  });
  
  // Ensamblar el filtro
  filterContainer.appendChild(label);
  filterContainer.appendChild(select);
  filterContainer.appendChild(counter);
  filterContainer.appendChild(progressIndicator);
  
  // Insertar el filtro antes de la tabla
  const tableContainer = table.closest('.directory-table-container') || table.parentNode;
  if (tableContainer) {
    tableContainer.insertBefore(filterContainer, table);
  }
  
  // Actualizar contador inicial
  updateCounter();
  
  // Observar cambios en las celdas de ubicaci√≥n para actualizar el filtro
  const observer = new MutationObserver(() => {
    updateLocationOptions();
    updateCounter();
  });
  
  // Observar cambios en el contenido de las celdas de ubicaci√≥n
  const locationCells = table.querySelectorAll('.location-column-data');
  locationCells.forEach(cell => {
    observer.observe(cell, { childList: true, characterData: true, subtree: true });
  });
  
  // Actualizar opciones cada 2 segundos hasta que se carguen todas las ubicaciones
  const updateInterval = setInterval(() => {
    updateLocationOptions();
    updateCounter();
    
    // Detener el intervalo si no hay m√°s celdas con "Cargando..." o "En cola..."
    const loadingCells = table.querySelectorAll('.location-column-data');
    const stillLoading = Array.from(loadingCells).some(cell => {
      const text = cell.textContent.trim();
      return text === 'Cargando...' || text === '‚è≥ En cola...';
    });
    
    if (!stillLoading) {
      clearInterval(updateInterval);
      progressIndicator.style.display = 'none';
    }
  }, 2000);
  
  console.log('‚úÖ Filtro por ubicaci√≥n agregado exitosamente');
}

// Funci√≥n para agregar columna a tabla tradicional
async function addColumnToTraditionalTable(thead, tbody) {
  const headerRow = thead.querySelector('tr');
  if (!headerRow) return;
  
  // Agregar encabezado de columna
  const locationHeader = document.createElement('th');
  locationHeader.className = 'location-column-header';
  locationHeader.textContent = 'Location';
  locationHeader.style.minWidth = '120px';
  locationHeader.style.textAlign = 'center';
  
  // Insertar antes de la √∫ltima columna
  const lastHeader = headerRow.querySelector('th:last-child');
  if (lastHeader) {
    headerRow.insertBefore(locationHeader, lastHeader);
  } else {
    headerRow.appendChild(locationHeader);
  }
  
  // Agregar celdas de datos
  const rows = tbody.querySelectorAll('tr');
  console.log(`üìù Agregando celdas para ${rows.length} filas...`);
  
  for (const row of rows) {
    await addLocationCellToRow(row);
  }
}

// Funci√≥n para agregar columna a tabla alternativa
async function addColumnToAlternativeTable(headerRow, dataRows) {
  // Agregar encabezado de columna
  const locationHeader = document.createElement('th');
  locationHeader.className = 'location-column-header';
  locationHeader.textContent = 'Location';
  locationHeader.style.minWidth = '120px';
  locationHeader.style.textAlign = 'center';
  
  // Insertar antes de la √∫ltima columna
  const lastHeader = headerRow.querySelector('th:last-child');
  if (lastHeader) {
    headerRow.insertBefore(locationHeader, lastHeader);
  } else {
    headerRow.appendChild(locationHeader);
  }
  
  // Agregar celdas de datos
  console.log(`üìù Agregando celdas para ${dataRows.length} filas...`);
  
  for (const row of dataRows) {
    await addLocationCellToRow(row);
  }
}

// Funci√≥n para agregar celda de ubicaci√≥n a una fila tradicional
async function addLocationCellToRow(row) {
  const locationCell = document.createElement('td');
  locationCell.className = 'location-column-data';
  locationCell.style.textAlign = 'center';
  locationCell.style.verticalAlign = 'middle';
  
  // Obtener el username de la fila
  const usernameLink = row.querySelector('td:first-child a');
  if (usernameLink) {
    const username = usernameLink.textContent.trim();
    
    // Mostrar "Cargando..." inicialmente
    locationCell.textContent = 'Cargando...';
    locationCell.style.fontStyle = 'italic';
    locationCell.style.color = '#666';
    
    // Obtener la ubicaci√≥n del usuario
    getUserLocation(username).then(location => {
      locationCell.textContent = location;
      locationCell.style.fontStyle = 'normal';
      locationCell.style.color = '#40312a';
      
      // Aplicar estilos especiales para ubicaciones v√°lidas
      if (location !== 'N/A') {
        locationCell.style.fontWeight = '500';
        locationCell.style.color = '#8A4A19';
      }
    });
  } else {
    locationCell.textContent = 'N/A';
  }
  
  // Insertar la celda en la posici√≥n correcta
  const lastCell = row.querySelector('td:last-child');
  if (lastCell) {
    row.insertBefore(locationCell, lastCell);
  } else {
    row.appendChild(locationCell);
  }
}

// Funci√≥n para aplicar estilos CSS del footer
function applyFooterStyles() {
  const style = document.createElement('style');
  style.setAttribute('data-footer-css', 'true');
  style.textContent = `
    /* Estilos para el footer personalizado de Youth Care Assembly */
    .yc-footer-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px 15px;
    }

    .yc-footer-divider {
      border: none;
      height: 1px;
      background-color: var(--border-secondary);
      margin: 0 0 30px 0;
    }

    .yc-footer-row {
      margin-bottom: 20px;
    }

    .yc-footer-logos {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      align-items: center;
      gap: 20px;
    }

    .yc-footer-logo {
      display: inline-block;
      transition: transform 0.3s ease, opacity 0.3s ease;
      text-decoration: none;
    }

    .yc-footer-logo:hover {
      transform: scale(1.05);
      opacity: 0.8;
    }

    .yc-footer-logo img {
      max-height: 60px;
      max-width: 120px;
      width: auto;
      height: auto;
      object-fit: contain;
      filter: grayscale(20%);
      transition: filter 0.3s ease;
    }

    .yc-footer-logo:hover img {
      filter: grayscale(0%);
    }

    /* Fila de informaci√≥n de la UE */
    .yc-footer-eu-row {
      margin-top: 30px;
      padding-top: 20px;
    }

    .yc-footer-eu-content {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 30px;
      flex-wrap: wrap;
    }

    .yc-footer-eu-logo {
      flex-shrink: 0;
    }

    .yc-footer-eu-logo img {
      max-height: 80px;
      max-width: 200px;
      width: auto;
      height: auto;
      object-fit: contain;
    }

    .yc-footer-eu-text {
      flex: 1;
      min-width: 300px;
      max-width: 600px;
    }

    .yc-footer-eu-text p {
      font-size: 10pt;
      font-family: Arial, sans-serif;
      color: var(--text-secondary);
      line-height: 1.4;
      margin: 0;
      text-align: center;
    }

    /* Responsive design */
    @media (max-width: 768px) {
      .yc-footer-container {
        padding: 15px 10px;
      }
      
      .yc-footer-logos {
        gap: 15px;
      }
      
      .yc-footer-logo img {
        max-height: 50px;
        max-width: 100px;
      }
      
      .yc-footer-eu-content {
        flex-direction: column;
        gap: 20px;
        text-align: center;
      }
      
      .yc-footer-eu-text {
        min-width: auto;
        max-width: none;
      }
      
      .yc-footer-eu-text p {
        font-size: 9pt;
      }
    }

    @media (max-width: 480px) {
      .yc-footer-logos {
        gap: 10px;
      }
      
      .yc-footer-logo img {
        max-height: 40px;
        max-width: 80px;
      }
      
      .yc-footer-eu-logo img {
        max-height: 60px;
        max-width: 150px;
      }
    }
  `;
  document.head.appendChild(style);
}

// Funci√≥n para aplicar estilos CSS
function applyLocationColumnStyles() {
  const style = document.createElement('style');
  style.setAttribute('data-location-column', 'true');
  style.textContent = `
    .location-column-header {
      color: var(--text-primary) !important;
      font-weight: 600 !important;
      padding: 8px 12px !important;
      text-align: center !important;
      vertical-align: middle !important;
    }
    
    .location-column-data {
      color: var(--text-primary) !important;
      font-size: 0.9em !important;
      padding: 8px 12px !important;
      text-align: center !important;
      vertical-align: middle !important;
      transition: all 0.2s ease !important;
    }
    
    .location-column-data:hover {
      color: var(--text-primary) !important;
    }
    
    /* Estilos para tablas modernas de Discourse */
    .directory-table .location-column-header {
      color: var(--text-primary) !important;
      font-weight: 600 !important;
      padding: 8px 12px !important;
      text-align: center !important;
      vertical-align: middle !important;
    }
    
    .directory-table .location-column-data {
      color: var(--text-primary) !important;
      font-size: 0.9em !important;
      padding: 8px 12px !important;
      text-align: center !important;
      vertical-align: middle !important;
      transition: all 0.2s ease !important;
    }
    
    .directory-table .location-column-data:hover {
      color: var(--text-primary) !important;
    }
    
    /* Estilos para el filtro por ubicaci√≥n */
    .location-filter-container {
      margin: 10px 0 !important;
      padding: 10px !important;
      background-color: var(--bg-tertiary) !important;
      border: 1px solid var(--border-primary) !important;
      border-radius: 4px !important;
      display: flex !important;
      align-items: center !important;
      gap: 10px !important;
    }
    
    .location-filter-container label {
      font-weight: 600 !important;
      color: var(--text-primary) !important;
      margin-right: 5px !important;
    }
    
    .location-filter-select {
      padding: 5px 10px !important;
      border: 1px solid #e0c052 !important;
      border-radius: 4px !important;
      background-color: var(--bg-primary) !important;
      color: var(--text-primary) !important;
      font-size: 14px !important;
      min-width: 150px !important;
    }
    
    .location-filter-select:hover {
      border-color: #d4b847 !important;
    }
    
    .location-filter-select:focus {
      outline: none !important;
      border-color: var(--text-secondary) !important;
      box-shadow: 0 0 0 2px rgba(138, 74, 25, 0.2) !important;
    }
    
    .location-filter-counter {
      color: var(--text-secondary) !important;
      font-weight: 500 !important;
      font-size: 14px !important;
    }
    
    .location-progress-indicator {
      color: var(--text-secondary) !important;
      font-size: 12px !important;
      font-style: italic !important;
      animation: pulse 2s infinite !important;
    }
    
    .loading-indicator {
      animation: pulse 1.5s infinite !important;
      color: #e0c052 !important;
    }
    
    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.5; }
      100% { opacity: 1; }
    }
    
    /* Estilos para la tabla completa */
    .admin-users-table table,
    .admin-users table,
    .users-table table,
    .admin-users-list table,
    .admin-users-list,
    .directory-table {
      border-collapse: collapse !important;
    }
    
    .admin-users-table th,
    .admin-users-table td,
    .admin-users th,
    .admin-users td,
    .users-table th,
    .users-table td,
    .admin-users-list th,
    .admin-users-list td,
    .directory-table__column-header,
    .directory-table__cell {
    }
  `;
  document.head.appendChild(style);
}

// Funci√≥n para limpiar la columna cuando se cambia de p√°gina
function cleanupLocationColumn() {
  const existingHeader = document.querySelector('.location-column-header');
  const existingCells = document.querySelectorAll('.location-column-data');
  const existingStyle = document.querySelector('style[data-location-column]');
  const existingFilter = document.querySelector('.location-filter-container');
  
  if (existingHeader) existingHeader.remove();
  existingCells.forEach(cell => cell.remove());
  if (existingStyle) existingStyle.remove();
  if (existingFilter) existingFilter.remove();
  
  // Limpiar cola de usuarios pendientes
  pendingUsersQueue.length = 0;
  activeRequests = 0;
}

// Funci√≥n para limpiar el cache (√∫til para debugging o cuando se quiera refrescar datos)
function clearLocationCache() {
  userLocationCache.clear();
  localStorage.removeItem('userLocationCache');
  console.log('üóëÔ∏è Cache de ubicaciones limpiado');
}

// Funci√≥n para mostrar estad√≠sticas del cache (√∫til para debugging)
function showCacheStats() {
  const cacheSize = userLocationCache.size;
  const pendingCount = pendingUsersQueue.length;
  const activeCount = activeRequests;
  
  console.log(`üìä Estad√≠sticas del cache:
    - Ubicaciones en cache: ${cacheSize}
    - Usuarios en cola: ${pendingCount}
    - Llamadas activas: ${activeCount}
    - Tama√±o del cache en localStorage: ${localStorage.getItem('userLocationCache') ? JSON.parse(localStorage.getItem('userLocationCache')).length : 0} items`);
  
  return { cacheSize, pendingCount, activeCount };
}

// Hacer funciones disponibles globalmente para debugging
window.clearLocationCache = clearLocationCache;
window.showCacheStats = showCacheStats;

// Funci√≥n principal que se ejecuta cuando Discourse est√© listo
async function initLocationColumn() {
  try {
    // Esperar a que Discourse est√© completamente cargado
    await waitForDiscourse();
    
    console.log('üöÄ Inicializando columna Location...');
    
    // Ejecutar cuando se carga la p√°gina
    await addLocationColumn();
    
    // Ejecutar cuando cambia la URL (navegaci√≥n SPA de Discourse)
    let currentUrl = window.location.href;
    const observer = new MutationObserver(function() {
      if (window.location.href !== currentUrl) {
        currentUrl = window.location.href;
        
        // Limpiar columna anterior
        cleanupLocationColumn();
        
        // Agregar nueva columna
        setTimeout(addLocationColumn, 1000);
      }
    });
    
    observer.observe(document.body, {
      childList: true,
      subtree: true
    });
    
    // Tambi√©n ejecutar cuando se hace clic en enlaces de navegaci√≥n
    document.addEventListener('click', function(event) {
      const target = event.target.closest('a');
      if (target && target.href) {
        const href = target.href;
        const isAdminUsersLink = href.includes('/admin/users/list/');
        const isPublicUsersLink = href.includes('/u') && (href.includes('order=') || href.endsWith('/u'));
        
        if (isAdminUsersLink || isPublicUsersLink) {
          setTimeout(() => {
            cleanupLocationColumn();
            addLocationColumn();
          }, 1000);
        }
      }
    });
    
    // Ejecutar cuando se cambia entre pesta√±as (Active, New, Staff, etc.) o ordenamientos p√∫blicos
    document.addEventListener('click', function(event) {
      const target = event.target.closest('a');
      if (target && target.classList.contains('ember-view')) {
        const href = target.getAttribute('href');
        if (href && (href.includes('/admin/users/list/') || href.includes('/admin/groups') || (href.includes('/u') && (href.includes('order=') || href.endsWith('/u'))))) {
          setTimeout(() => {
            cleanupLocationColumn();
            addLocationColumn();
          }, 1500);
        }
      }
    });
    
    console.log('üöÄ Columna Location inicializada correctamente');
    
  } catch (error) {
    console.log('‚ùå Error inicializando columna Location:', error);
  }
}

// Aplicar estilos del footer inmediatamente al cargar la p√°gina
applyFooterStyles();

// Iniciar cuando el DOM est√© listo
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initLocationColumn);
} else {
  initLocationColumn();
}
</script>
